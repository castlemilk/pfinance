
> pfinance@0.1.1 test
> jest src/app/__tests__/integration/expense-creation.test.tsx

watchman warning:  Recrawled this watch 3 times, most recently because:
MustScanSubDirs UserDroppedTo resolve, please review the information on
https://facebook.github.io/watchman/docs/troubleshooting.html#recrawl
To clear this warning, run:
`watchman watch-del '/Users/benebsworth/projects/pfinance' ; watchman watch-project '/Users/benebsworth/projects/pfinance'`

  console.log
    [AuthContext] State: {
      loading: true,
      actualUser: null,
      effectiveUser: null,
      isAdminMode: false,
      hasImpersonatedUser: false,
      authInitialized: true
    }

      at log (src/app/context/AuthWithAdminContext.tsx:43:11)

  console.log
    [FinanceContext] State: {
      authLoading: true,
      user: null,
      isDevMode: false,
      useApi: false,
      effectiveUserId: '',
      dataLoaded: false,
      loading: true,
      expensesCount: 0,
      incomesCount: 0
    }

      at log (src/app/context/FinanceContext.tsx:228:11)

  console.log
    [FinanceContext] useEffect triggered {
      effectiveUserId: '',
      useApi: false,
      lastUserIdRef: '',
      dataLoaded: false,
      isLoadingRef: false
    }

      at log (src/app/context/FinanceContext.tsx:362:13)

  console.log
    [FinanceContext] useEffect - loading data for user:

      at log (src/app/context/FinanceContext.tsx:377:13)

  console.log
    [FinanceContext] loadData called { isLoadingRef: false, shouldUseApi: false, userId: '' }

      at log (src/app/context/FinanceContext.tsx:280:13)

  console.log
    [FinanceContext] Loading from localStorage (no API/user)

      at log (src/app/context/FinanceContext.tsx:353:15)

  console.log
    [AuthContext] useEffect - setting up auth listener, auth initialized: true

      at log (src/app/context/AuthWithAdminContext.tsx:53:13)

  console.log
    [FinanceContext] useEffect cleanup

      at log (src/app/context/FinanceContext.tsx:388:15)

  console.log
    [AuthContext] State: {
      loading: true,
      actualUser: null,
      effectiveUser: null,
      isAdminMode: false,
      hasImpersonatedUser: false,
      authInitialized: true
    }

      at log (src/app/context/AuthWithAdminContext.tsx:43:11)

  console.log
    [FinanceContext] State: {
      authLoading: true,
      user: null,
      isDevMode: false,
      useApi: false,
      effectiveUserId: '',
      dataLoaded: false,
      loading: true,
      expensesCount: 0,
      incomesCount: 0
    }

      at log (src/app/context/FinanceContext.tsx:228:11)

  console.log
    [FinanceContext] useEffect triggered {
      effectiveUserId: '',
      useApi: false,
      lastUserIdRef: '',
      dataLoaded: false,
      isLoadingRef: false
    }

      at log (src/app/context/FinanceContext.tsx:362:13)

  console.log
    [FinanceContext] useEffect - loading data for user:

      at log (src/app/context/FinanceContext.tsx:377:13)

  console.log
    [FinanceContext] loadData called { isLoadingRef: false, shouldUseApi: false, userId: '' }

      at log (src/app/context/FinanceContext.tsx:280:13)

  console.log
    [FinanceContext] Loading from localStorage (no API/user)

      at log (src/app/context/FinanceContext.tsx:353:15)

  console.log
    [AuthContext] useEffect - setting up auth listener, auth initialized: true

      at log (src/app/context/AuthWithAdminContext.tsx:53:13)

  console.log
    [FinanceContext] useEffect cleanup

      at log (src/app/context/FinanceContext.tsx:388:15)

(node:51778) [DEP0040] DeprecationWarning: The `punycode` module is deprecated. Please use a userland alternative instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
FAIL src/app/__tests__/integration/expense-creation.test.tsx
  Personal Expense Creation
    ✕ should create a personal expense and save to localStorage (59 ms)
    ✕ should not make API calls for personal expenses (21 ms)

  ● Personal Expense Creation › should create a personal expense and save to localStorage

    TypeError: Cannot read properties of undefined (reading 'then')

      63 |     
      64 |     // Set persistence to local (survives browser restarts)
    > 65 |     setPersistence(auth, browserLocalPersistence)
         |                                                 ^
      66 |       .then(() => {
      67 |         console.log('[AuthContext] Persistence set, subscribing to auth state');
      68 |         // TypeScript needs reassurance that auth is still not null in async callback

      at src/app/context/AuthWithAdminContext.tsx:65:49
      at Object.react_stack_bottom_frame (node_modules/react-dom/cjs/react-dom-client.development.js:25989:20)
      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)
      at commitHookEffectListMount (node_modules/react-dom/cjs/react-dom-client.development.js:13249:29)
      at commitHookPassiveMountEffects (node_modules/react-dom/cjs/react-dom-client.development.js:13336:11)
      at commitPassiveMountOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:15484:13)
      at recursivelyTraversePassiveMountEffects (node_modules/react-dom/cjs/react-dom-client.development.js:15439:11)
      at commitPassiveMountOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:15718:11)
      at recursivelyTraversePassiveMountEffects (node_modules/react-dom/cjs/react-dom-client.development.js:15439:11)
      at commitPassiveMountOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:15476:11)
      at recursivelyTraversePassiveMountEffects (node_modules/react-dom/cjs/react-dom-client.development.js:15439:11)
      at commitPassiveMountOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:15519:11)
      at flushPassiveEffects (node_modules/react-dom/cjs/react-dom-client.development.js:18432:9)
      at flushPendingEffects (node_modules/react-dom/cjs/react-dom-client.development.js:18358:14)
      at performSyncWorkOnRoot (node_modules/react-dom/cjs/react-dom-client.development.js:18969:11)
      at flushSyncWorkAcrossRoots_impl (node_modules/react-dom/cjs/react-dom-client.development.js:18814:21)
      at flushSpawnedWork (node_modules/react-dom/cjs/react-dom-client.development.js:18334:9)
      at commitRoot (node_modules/react-dom/cjs/react-dom-client.development.js:17955:9)
      at performWorkOnRoot (node_modules/react-dom/cjs/react-dom-client.development.js:16667:15)
      at performWorkOnRootViaSchedulerTask (node_modules/react-dom/cjs/react-dom-client.development.js:18957:7)
      at flushActQueue (node_modules/react/cjs/react.development.js:590:34)
      at Object.<anonymous>.process.env.NODE_ENV.exports.act (node_modules/react/cjs/react.development.js:884:10)
      at node_modules/@testing-library/react/dist/act-compat.js:47:25
      at renderRoot (node_modules/@testing-library/react/dist/pure.js:180:26)
      at render (node_modules/@testing-library/react/dist/pure.js:271:10)
      at Object.<anonymous> (src/app/__tests__/integration/expense-creation.test.tsx:55:11)

  ● Personal Expense Creation › should not make API calls for personal expenses

    TypeError: Cannot read properties of undefined (reading 'then')

      63 |     
      64 |     // Set persistence to local (survives browser restarts)
    > 65 |     setPersistence(auth, browserLocalPersistence)
         |                                                 ^
      66 |       .then(() => {
      67 |         console.log('[AuthContext] Persistence set, subscribing to auth state');
      68 |         // TypeScript needs reassurance that auth is still not null in async callback

      at src/app/context/AuthWithAdminContext.tsx:65:49
      at Object.react_stack_bottom_frame (node_modules/react-dom/cjs/react-dom-client.development.js:25989:20)
      at runWithFiberInDEV (node_modules/react-dom/cjs/react-dom-client.development.js:874:13)
      at commitHookEffectListMount (node_modules/react-dom/cjs/react-dom-client.development.js:13249:29)
      at commitHookPassiveMountEffects (node_modules/react-dom/cjs/react-dom-client.development.js:13336:11)
      at commitPassiveMountOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:15484:13)
      at recursivelyTraversePassiveMountEffects (node_modules/react-dom/cjs/react-dom-client.development.js:15439:11)
      at commitPassiveMountOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:15718:11)
      at recursivelyTraversePassiveMountEffects (node_modules/react-dom/cjs/react-dom-client.development.js:15439:11)
      at commitPassiveMountOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:15476:11)
      at recursivelyTraversePassiveMountEffects (node_modules/react-dom/cjs/react-dom-client.development.js:15439:11)
      at commitPassiveMountOnFiber (node_modules/react-dom/cjs/react-dom-client.development.js:15519:11)
      at flushPassiveEffects (node_modules/react-dom/cjs/react-dom-client.development.js:18432:9)
      at flushPendingEffects (node_modules/react-dom/cjs/react-dom-client.development.js:18358:14)
      at performSyncWorkOnRoot (node_modules/react-dom/cjs/react-dom-client.development.js:18969:11)
      at flushSyncWorkAcrossRoots_impl (node_modules/react-dom/cjs/react-dom-client.development.js:18814:21)
      at flushSpawnedWork (node_modules/react-dom/cjs/react-dom-client.development.js:18334:9)
      at commitRoot (node_modules/react-dom/cjs/react-dom-client.development.js:17955:9)
      at performWorkOnRoot (node_modules/react-dom/cjs/react-dom-client.development.js:16667:15)
      at performWorkOnRootViaSchedulerTask (node_modules/react-dom/cjs/react-dom-client.development.js:18957:7)
      at flushActQueue (node_modules/react/cjs/react.development.js:590:34)
      at Object.<anonymous>.process.env.NODE_ENV.exports.act (node_modules/react/cjs/react.development.js:884:10)
      at node_modules/@testing-library/react/dist/act-compat.js:47:25
      at renderRoot (node_modules/@testing-library/react/dist/pure.js:180:26)
      at render (node_modules/@testing-library/react/dist/pure.js:271:10)
      at Object.<anonymous> (src/app/__tests__/integration/expense-creation.test.tsx:112:11)

Test Suites: 1 failed, 1 total
Tests:       2 failed, 2 total
Snapshots:   0 total
Time:        0.869 s, estimated 1 s
Ran all test suites matching /src\/app\/__tests__\/integration\/expense-creation.test.tsx/i.

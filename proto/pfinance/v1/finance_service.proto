syntax = "proto3";

package pfinance.v1;

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";
import "pfinance/v1/types.proto";

// FinanceService handles all finance-related operations
service FinanceService {
  // User operations
  rpc GetUser(GetUserRequest) returns (GetUserResponse);
  rpc UpdateUser(UpdateUserRequest) returns (UpdateUserResponse);
  rpc DeleteUser(DeleteUserRequest) returns (google.protobuf.Empty);
  rpc ExportUserData(ExportUserDataRequest) returns (ExportUserDataResponse);

  // Expense operations
  rpc CreateExpense(CreateExpenseRequest) returns (CreateExpenseResponse);
  rpc GetExpense(GetExpenseRequest) returns (GetExpenseResponse);
  rpc UpdateExpense(UpdateExpenseRequest) returns (UpdateExpenseResponse);
  rpc DeleteExpense(DeleteExpenseRequest) returns (google.protobuf.Empty);
  rpc ListExpenses(ListExpensesRequest) returns (ListExpensesResponse);
  rpc BatchCreateExpenses(BatchCreateExpensesRequest) returns (BatchCreateExpensesResponse);

  // Income operations
  rpc CreateIncome(CreateIncomeRequest) returns (CreateIncomeResponse);
  rpc GetIncome(GetIncomeRequest) returns (GetIncomeResponse);
  rpc UpdateIncome(UpdateIncomeRequest) returns (UpdateIncomeResponse);
  rpc DeleteIncome(DeleteIncomeRequest) returns (google.protobuf.Empty);
  rpc ListIncomes(ListIncomesRequest) returns (ListIncomesResponse);

  // Tax configuration
  rpc GetTaxConfig(GetTaxConfigRequest) returns (GetTaxConfigResponse);
  rpc UpdateTaxConfig(UpdateTaxConfigRequest) returns (UpdateTaxConfigResponse);

  // Group operations
  rpc CreateGroup(CreateGroupRequest) returns (CreateGroupResponse);
  rpc GetGroup(GetGroupRequest) returns (GetGroupResponse);
  rpc UpdateGroup(UpdateGroupRequest) returns (UpdateGroupResponse);
  rpc DeleteGroup(DeleteGroupRequest) returns (google.protobuf.Empty);
  rpc ListGroups(ListGroupsRequest) returns (ListGroupsResponse);

  // Group member operations
  rpc InviteToGroup(InviteToGroupRequest) returns (InviteToGroupResponse);
  rpc AcceptInvitation(AcceptInvitationRequest) returns (AcceptInvitationResponse);
  rpc DeclineInvitation(DeclineInvitationRequest) returns (google.protobuf.Empty);
  rpc RemoveFromGroup(RemoveFromGroupRequest) returns (google.protobuf.Empty);
  rpc UpdateMemberRole(UpdateMemberRoleRequest) returns (UpdateMemberRoleResponse);

  // Invitation operations
  rpc ListInvitations(ListInvitationsRequest) returns (ListInvitationsResponse);

  // Budget operations
  rpc CreateBudget(CreateBudgetRequest) returns (CreateBudgetResponse);
  rpc GetBudget(GetBudgetRequest) returns (GetBudgetResponse);
  rpc UpdateBudget(UpdateBudgetRequest) returns (UpdateBudgetResponse);
  rpc DeleteBudget(DeleteBudgetRequest) returns (google.protobuf.Empty);
  rpc ListBudgets(ListBudgetsRequest) returns (ListBudgetsResponse);
  rpc GetBudgetProgress(GetBudgetProgressRequest) returns (GetBudgetProgressResponse);

  // Expense allocation operations
  rpc GetMemberBalances(GetMemberBalancesRequest) returns (GetMemberBalancesResponse);
  rpc SettleExpense(SettleExpenseRequest) returns (SettleExpenseResponse);
  rpc GetGroupSummary(GetGroupSummaryRequest) returns (GetGroupSummaryResponse);

  // Invite link operations
  rpc CreateInviteLink(CreateInviteLinkRequest) returns (CreateInviteLinkResponse);
  rpc GetInviteLinkByCode(GetInviteLinkByCodeRequest) returns (GetInviteLinkByCodeResponse);
  rpc JoinGroupByLink(JoinGroupByLinkRequest) returns (JoinGroupByLinkResponse);
  rpc ListInviteLinks(ListInviteLinksRequest) returns (ListInviteLinksResponse);
  rpc DeactivateInviteLink(DeactivateInviteLinkRequest) returns (google.protobuf.Empty);

  // Contribution operations
  rpc ContributeExpenseToGroup(ContributeExpenseToGroupRequest) returns (ContributeExpenseToGroupResponse);
  rpc ContributeIncomeToGroup(ContributeIncomeToGroupRequest) returns (ContributeIncomeToGroupResponse);
  rpc ListContributions(ListContributionsRequest) returns (ListContributionsResponse);
  rpc ListIncomeContributions(ListIncomeContributionsRequest) returns (ListIncomeContributionsResponse);

  // Goal operations
  rpc CreateGoal(CreateGoalRequest) returns (CreateGoalResponse);
  rpc GetGoal(GetGoalRequest) returns (GetGoalResponse);
  rpc UpdateGoal(UpdateGoalRequest) returns (UpdateGoalResponse);
  rpc DeleteGoal(DeleteGoalRequest) returns (google.protobuf.Empty);
  rpc ListGoals(ListGoalsRequest) returns (ListGoalsResponse);
  rpc GetGoalProgress(GetGoalProgressRequest) returns (GetGoalProgressResponse);
  rpc ContributeToGoal(ContributeToGoalRequest) returns (ContributeToGoalResponse);
  rpc ListGoalContributions(ListGoalContributionsRequest) returns (ListGoalContributionsResponse);

  // Spending insights operations
  rpc GetSpendingInsights(GetSpendingInsightsRequest) returns (GetSpendingInsightsResponse);

  // Document extraction operations
  rpc ExtractDocument(ExtractDocumentRequest) returns (ExtractDocumentResponse);
  rpc GetExtractionJob(GetExtractionJobRequest) returns (GetExtractionJobResponse);
  rpc ImportExtractedTransactions(ImportExtractedTransactionsRequest) returns (ImportExtractedTransactionsResponse);

  // Smart text parsing (uses AI to parse natural language expense descriptions)
  rpc ParseExpenseText(ParseExpenseTextRequest) returns (ParseExpenseTextResponse);

  // Recurring transaction operations
  rpc CreateRecurringTransaction(CreateRecurringTransactionRequest) returns (CreateRecurringTransactionResponse);
  rpc GetRecurringTransaction(GetRecurringTransactionRequest) returns (GetRecurringTransactionResponse);
  rpc UpdateRecurringTransaction(UpdateRecurringTransactionRequest) returns (UpdateRecurringTransactionResponse);
  rpc DeleteRecurringTransaction(DeleteRecurringTransactionRequest) returns (google.protobuf.Empty);
  rpc ListRecurringTransactions(ListRecurringTransactionsRequest) returns (ListRecurringTransactionsResponse);
  rpc PauseRecurringTransaction(PauseRecurringTransactionRequest) returns (PauseRecurringTransactionResponse);
  rpc ResumeRecurringTransaction(ResumeRecurringTransactionRequest) returns (ResumeRecurringTransactionResponse);
  rpc GetUpcomingBills(GetUpcomingBillsRequest) returns (GetUpcomingBillsResponse);
  rpc ProcessRecurringTransactions(ProcessRecurringTransactionsRequest) returns (ProcessRecurringTransactionsResponse);

  // Search operations
  rpc SearchTransactions(SearchTransactionsRequest) returns (SearchTransactionsResponse);

  // Subscription detection operations
  rpc DetectSubscriptions(DetectSubscriptionsRequest) returns (DetectSubscriptionsResponse);
  rpc ConvertToRecurring(ConvertToRecurringRequest) returns (ConvertToRecurringResponse);

  // Notification operations
  rpc ListNotifications(ListNotificationsRequest) returns (ListNotificationsResponse);
  rpc MarkNotificationRead(MarkNotificationReadRequest) returns (google.protobuf.Empty);
  rpc MarkAllNotificationsRead(MarkAllNotificationsReadRequest) returns (google.protobuf.Empty);
  rpc GetUnreadNotificationCount(GetUnreadNotificationCountRequest) returns (GetUnreadNotificationCountResponse);
  rpc GetNotificationPreferences(GetNotificationPreferencesRequest) returns (GetNotificationPreferencesResponse);
  rpc UpdateNotificationPreferences(UpdateNotificationPreferencesRequest) returns (UpdateNotificationPreferencesResponse);
  rpc GenerateWeeklyDigest(GenerateWeeklyDigestRequest) returns (GenerateWeeklyDigestResponse);

  // Stripe subscription operations
  rpc CreateCheckoutSession(CreateCheckoutSessionRequest) returns (CreateCheckoutSessionResponse);
  rpc GetSubscriptionStatus(GetSubscriptionStatusRequest) returns (GetSubscriptionStatusResponse);
  rpc CancelSubscription(CancelSubscriptionRequest) returns (CancelSubscriptionResponse);
  rpc VerifyCheckoutSession(VerifyCheckoutSessionRequest) returns (VerifyCheckoutSessionResponse);

  // Analytics operations (Pro tier)
  rpc GetDailyAggregates(GetDailyAggregatesRequest) returns (GetDailyAggregatesResponse);
  rpc GetSpendingTrends(GetSpendingTrendsRequest) returns (GetSpendingTrendsResponse);
  rpc GetCategoryComparison(GetCategoryComparisonRequest) returns (GetCategoryComparisonResponse);
  rpc DetectAnomalies(DetectAnomaliesRequest) returns (DetectAnomaliesResponse);
  rpc GetCashFlowForecast(GetCashFlowForecastRequest) returns (GetCashFlowForecastResponse);
  rpc GetWaterfallData(GetWaterfallDataRequest) returns (GetWaterfallDataResponse);

  // ML Feedback operations
  rpc SubmitCorrections(SubmitCorrectionsRequest) returns (SubmitCorrectionsResponse);
  rpc CheckDuplicates(CheckDuplicatesRequest) returns (CheckDuplicatesResponse);
  rpc GetMerchantSuggestions(GetMerchantSuggestionsRequest) returns (GetMerchantSuggestionsResponse);
  rpc GetExtractionMetrics(GetExtractionMetricsRequest) returns (GetExtractionMetricsResponse);

  // Tax returns operations (Pro tier)
  rpc GetTaxSummary(GetTaxSummaryRequest) returns (GetTaxSummaryResponse);
  rpc GetTaxEstimate(GetTaxEstimateRequest) returns (GetTaxEstimateResponse);
  rpc BatchUpdateExpenseTaxStatus(BatchUpdateExpenseTaxStatusRequest) returns (BatchUpdateExpenseTaxStatusResponse);
  rpc ListDeductibleExpenses(ListDeductibleExpensesRequest) returns (ListDeductibleExpensesResponse);
  rpc ClassifyTaxDeductibility(ClassifyTaxDeductibilityRequest) returns (ClassifyTaxDeductibilityResponse);
  rpc BatchClassifyTaxDeductibility(BatchClassifyTaxDeductibilityRequest) returns (BatchClassifyTaxDeductibilityResponse);
  rpc ExportTaxReturn(ExportTaxReturnRequest) returns (ExportTaxReturnResponse);

  // API token operations (Pro tier)
  rpc CreateApiToken(CreateApiTokenRequest) returns (CreateApiTokenResponse);
  rpc ListApiTokens(ListApiTokensRequest) returns (ListApiTokensResponse);
  rpc RevokeApiToken(RevokeApiTokenRequest) returns (RevokeApiTokenResponse);
}

// User operations
message GetUserRequest {
  string user_id = 1;
}

message GetUserResponse {
  User user = 1;
}

message UpdateUserRequest {
  string user_id = 1;
  string display_name = 2;
  string photo_url = 3;
  string email = 4;
}

message UpdateUserResponse {
  User user = 1;
}

message DeleteUserRequest {
  string user_id = 1;
  bool confirm = 2; // Must be true to actually delete
}

message ExportUserDataRequest {
  string user_id = 1;
  string format = 2; // "json" or "csv"
}

message ExportUserDataResponse {
  bytes data = 1;
  string filename = 2;
  string content_type = 3;
}

// Expense operations
message CreateExpenseRequest {
  string user_id = 1;
  string group_id = 2; // Optional
  string description = 3;
  double amount = 4;
  ExpenseCategory category = 5;
  ExpenseFrequency frequency = 6;
  google.protobuf.Timestamp date = 7;

  // Allocation fields
  string paid_by_user_id = 8; // Who paid (defaults to user_id)
  SplitType split_type = 9; // How to split
  repeated string allocated_user_ids = 10; // Who to split between
  repeated ExpenseAllocation allocations = 11; // Custom allocations (for percentage/amount splits)
  repeated string tags = 12; // Optional tags
  int64 amount_cents = 13; // Amount in cents (preferred over amount)

  // Tax deduction fields
  bool is_tax_deductible = 14;
  TaxDeductionCategory tax_deduction_category = 15;
  string tax_deduction_note = 16;
  double tax_deductible_percent = 17; // 0.0-1.0
}

message CreateExpenseResponse {
  Expense expense = 1;
}

message GetExpenseRequest {
  string expense_id = 1;
}

message GetExpenseResponse {
  Expense expense = 1;
}

message UpdateExpenseRequest {
  string expense_id = 1;
  string description = 2;
  double amount = 3;
  ExpenseCategory category = 4;
  ExpenseFrequency frequency = 5;

  // Allocation fields
  string paid_by_user_id = 6;
  SplitType split_type = 7;
  repeated string allocated_user_ids = 8;
  repeated ExpenseAllocation allocations = 9;
  repeated string tags = 10;
  int64 amount_cents = 11; // Amount in cents (preferred over amount)

  // Tax deduction fields
  bool is_tax_deductible = 12;
  TaxDeductionCategory tax_deduction_category = 13;
  string tax_deduction_note = 14;
  double tax_deductible_percent = 15; // 0.0-1.0
}

message UpdateExpenseResponse {
  Expense expense = 1;
}

message DeleteExpenseRequest {
  string expense_id = 1;
}

message ListExpensesRequest {
  string user_id = 1;
  string group_id = 2; // Optional - filter by group
  google.protobuf.Timestamp start_date = 3;
  google.protobuf.Timestamp end_date = 4;
  int32 page_size = 5;
  string page_token = 6;
}

message ListExpensesResponse {
  repeated Expense expenses = 1;
  string next_page_token = 2;
}

message BatchCreateExpensesRequest {
  string user_id = 1;
  string group_id = 2; // Optional
  repeated CreateExpenseRequest expenses = 3;
}

message BatchCreateExpensesResponse {
  repeated Expense expenses = 1;
}

// Income operations
message CreateIncomeRequest {
  string user_id = 1;
  string group_id = 2; // Optional
  string source = 3;
  double amount = 4;
  IncomeFrequency frequency = 5;
  TaxStatus tax_status = 6;
  repeated Deduction deductions = 7;
  google.protobuf.Timestamp date = 8;
  int64 amount_cents = 9; // Amount in cents (preferred over amount)
}

message CreateIncomeResponse {
  Income income = 1;
}

message GetIncomeRequest {
  string income_id = 1;
}

message GetIncomeResponse {
  Income income = 1;
}

message UpdateIncomeRequest {
  string income_id = 1;
  string source = 2;
  double amount = 3;
  IncomeFrequency frequency = 4;
  TaxStatus tax_status = 5;
  repeated Deduction deductions = 6;
  int64 amount_cents = 7; // Amount in cents (preferred over amount)
}

message UpdateIncomeResponse {
  Income income = 1;
}

message DeleteIncomeRequest {
  string income_id = 1;
}

message ListIncomesRequest {
  string user_id = 1;
  string group_id = 2; // Optional - filter by group
  google.protobuf.Timestamp start_date = 3;
  google.protobuf.Timestamp end_date = 4;
  int32 page_size = 5;
  string page_token = 6;
}

message ListIncomesResponse {
  repeated Income incomes = 1;
  string next_page_token = 2;
}

// Tax configuration
message GetTaxConfigRequest {
  string user_id = 1;
  string group_id = 2; // Optional
}

message GetTaxConfigResponse {
  TaxConfig tax_config = 1;
}

message UpdateTaxConfigRequest {
  string user_id = 1;
  string group_id = 2; // Optional
  TaxConfig tax_config = 3;
}

message UpdateTaxConfigResponse {
  TaxConfig tax_config = 1;
}

// Group operations
message CreateGroupRequest {
  string owner_id = 1;
  string name = 2;
  string description = 3;
}

message CreateGroupResponse {
  FinanceGroup group = 1;
}

message GetGroupRequest {
  string group_id = 1;
}

message GetGroupResponse {
  FinanceGroup group = 1;
}

message UpdateGroupRequest {
  string group_id = 1;
  string name = 2;
  string description = 3;
}

message UpdateGroupResponse {
  FinanceGroup group = 1;
}

message DeleteGroupRequest {
  string group_id = 1;
}

message ListGroupsRequest {
  string user_id = 1;
  int32 page_size = 2;
  string page_token = 3;
}

message ListGroupsResponse {
  repeated FinanceGroup groups = 1;
  string next_page_token = 2;
}

// Group member operations
message InviteToGroupRequest {
  string group_id = 1;
  string inviter_id = 2;
  string invitee_email = 3;
  GroupRole role = 4;
}

message InviteToGroupResponse {
  GroupInvitation invitation = 1;
}

message AcceptInvitationRequest {
  string invitation_id = 1;
  string user_id = 2;
}

message AcceptInvitationResponse {
  FinanceGroup group = 1;
}

message DeclineInvitationRequest {
  string invitation_id = 1;
  string user_id = 2;
}

message RemoveFromGroupRequest {
  string group_id = 1;
  string user_id = 2;
}

message UpdateMemberRoleRequest {
  string group_id = 1;
  string user_id = 2;
  GroupRole new_role = 3;
}

message UpdateMemberRoleResponse {
  GroupMember member = 1;
}

// Invitation operations
message ListInvitationsRequest {
  string user_email = 1;
  InvitationStatus status = 2; // Optional filter
  int32 page_size = 3;
  string page_token = 4;
}

message ListInvitationsResponse {
  repeated GroupInvitation invitations = 1;
  string next_page_token = 2;
}

// Budget operations
message CreateBudgetRequest {
  string user_id = 1;
  string group_id = 2; // Optional
  string name = 3;
  string description = 4;
  double amount = 5;
  BudgetPeriod period = 6;
  repeated ExpenseCategory category_ids = 7;
  google.protobuf.Timestamp start_date = 8;
  google.protobuf.Timestamp end_date = 9; // Optional
  int64 amount_cents = 10; // Amount in cents (preferred over amount)
}

message CreateBudgetResponse {
  Budget budget = 1;
}

message GetBudgetRequest {
  string budget_id = 1;
}

message GetBudgetResponse {
  Budget budget = 1;
}

message UpdateBudgetRequest {
  string budget_id = 1;
  string name = 2;
  string description = 3;
  double amount = 4;
  BudgetPeriod period = 5;
  repeated ExpenseCategory category_ids = 6;
  bool is_active = 7;
  google.protobuf.Timestamp end_date = 8; // Optional
  int64 amount_cents = 9; // Amount in cents (preferred over amount)
}

message UpdateBudgetResponse {
  Budget budget = 1;
}

message DeleteBudgetRequest {
  string budget_id = 1;
}

message ListBudgetsRequest {
  string user_id = 1;
  string group_id = 2; // Optional - filter by group
  bool include_inactive = 3;
  int32 page_size = 4;
  string page_token = 5;
}

message ListBudgetsResponse {
  repeated Budget budgets = 1;
  string next_page_token = 2;
}

message GetBudgetProgressRequest {
  string budget_id = 1;
  google.protobuf.Timestamp as_of_date = 2; // Optional - defaults to current date
}

message GetBudgetProgressResponse {
  BudgetProgress progress = 1;
}

// Expense allocation operations
message GetMemberBalancesRequest {
  string group_id = 1;
  string user_id = 2; // Optional - filter for specific user
  google.protobuf.Timestamp start_date = 3; // Optional
  google.protobuf.Timestamp end_date = 4; // Optional
}

message GetMemberBalancesResponse {
  repeated MemberBalance balances = 1;
  double total_group_expenses = 2;
  int64 total_group_expenses_cents = 3; // Total in cents (preferred over total_group_expenses)
}

message SettleExpenseRequest {
  string expense_id = 1;
  string user_id = 2; // User settling their allocation
  double amount = 3; // Amount being settled (could be partial)
  int64 amount_cents = 4; // Amount in cents (preferred over amount)
}

message SettleExpenseResponse {
  Expense expense = 1;
  ExpenseAllocation updated_allocation = 2;
}

message GetGroupSummaryRequest {
  string group_id = 1;
  google.protobuf.Timestamp start_date = 2; // Optional
  google.protobuf.Timestamp end_date = 3; // Optional
}

message GetGroupSummaryResponse {
  double total_expenses = 1;
  double total_income = 2;
  repeated ExpenseBreakdown expense_by_category = 3;
  repeated MemberBalance member_balances = 4;
  int32 unsettled_expense_count = 5;
  double unsettled_amount = 6;
  int64 total_expenses_cents = 7; // Total expenses in cents (preferred over total_expenses)
  int64 total_income_cents = 8; // Total income in cents (preferred over total_income)
  int64 unsettled_amount_cents = 9; // Unsettled amount in cents (preferred over unsettled_amount)
}

// Invite link operations
message CreateInviteLinkRequest {
  string group_id = 1;
  string created_by = 2;
  GroupRole default_role = 3;
  int32 max_uses = 4; // 0 means unlimited
  int32 expires_in_days = 5; // 0 means never expires
}

message CreateInviteLinkResponse {
  GroupInviteLink invite_link = 1;
}

message GetInviteLinkByCodeRequest {
  string code = 1;
}

message GetInviteLinkByCodeResponse {
  GroupInviteLink invite_link = 1;
  FinanceGroup group = 2; // Include group details for preview
}

message JoinGroupByLinkRequest {
  string code = 1;
  string user_id = 2;
  string user_email = 3;
  string display_name = 4;
}

message JoinGroupByLinkResponse {
  FinanceGroup group = 1;
}

message ListInviteLinksRequest {
  string group_id = 1;
  bool include_inactive = 2;
  int32 page_size = 3;
  string page_token = 4;
}

message ListInviteLinksResponse {
  repeated GroupInviteLink invite_links = 1;
  string next_page_token = 2;
}

message DeactivateInviteLinkRequest {
  string link_id = 1;
}

// Contribution operations
message ContributeExpenseToGroupRequest {
  string source_expense_id = 1;
  string target_group_id = 2;
  string contributed_by = 3;
  double amount = 4; // Amount to contribute (can be partial)
  SplitType split_type = 5;
  repeated string allocated_user_ids = 6;
  repeated ExpenseAllocation allocations = 7; // Custom allocations
  int64 amount_cents = 8; // Amount in cents (preferred over amount)
}

message ContributeExpenseToGroupResponse {
  ExpenseContribution contribution = 1;
  Expense created_group_expense = 2;
}

message ListContributionsRequest {
  string group_id = 1; // Optional - filter by group
  string user_id = 2; // Optional - filter by contributor
  int32 page_size = 3;
  string page_token = 4;
}

message ListContributionsResponse {
  repeated ExpenseContribution contributions = 1;
  string next_page_token = 2;
}

// Income contribution operations
message ContributeIncomeToGroupRequest {
  string source_income_id = 1;
  string target_group_id = 2;
  string contributed_by = 3;
  double amount = 4; // Amount to contribute (can be partial, defaults to full income amount)
  int64 amount_cents = 5;           // Amount in cents (preferred over amount)
}

message ContributeIncomeToGroupResponse {
  IncomeContribution contribution = 1;
  Income created_group_income = 2;
}

message ListIncomeContributionsRequest {
  string group_id = 1; // Optional - filter by group
  string user_id = 2; // Optional - filter by contributor
  int32 page_size = 3;
  string page_token = 4;
}

message ListIncomeContributionsResponse {
  repeated IncomeContribution contributions = 1;
  string next_page_token = 2;
}

// ============================================================================
// Goal operations
// ============================================================================

message CreateGoalRequest {
  string user_id = 1;
  string group_id = 2;              // Optional: for shared goals
  string name = 3;
  string description = 4;
  GoalType goal_type = 5;
  double target_amount = 6;
  double initial_amount = 7;        // Starting amount (optional)
  google.protobuf.Timestamp start_date = 8;
  google.protobuf.Timestamp target_date = 9;
  repeated ExpenseCategory category_ids = 10; // For SPENDING_LIMIT type
  string icon = 11;                  // Emoji or icon name
  string color = 12;                 // Hex color for UI
  int64 target_amount_cents = 13;    // Target amount in cents (preferred over target_amount)
  int64 initial_amount_cents = 14;   // Initial amount in cents (preferred over initial_amount)
}

message CreateGoalResponse {
  FinancialGoal goal = 1;
}

message GetGoalRequest {
  string goal_id = 1;
}

message GetGoalResponse {
  FinancialGoal goal = 1;
}

message UpdateGoalRequest {
  string goal_id = 1;
  string name = 2;
  string description = 3;
  double target_amount = 4;
  google.protobuf.Timestamp target_date = 5;
  GoalStatus status = 6;
  repeated ExpenseCategory category_ids = 7;
  string icon = 8;
  string color = 9;
  int64 target_amount_cents = 10;    // Target amount in cents (preferred over target_amount)
}

message UpdateGoalResponse {
  FinancialGoal goal = 1;
}

message DeleteGoalRequest {
  string goal_id = 1;
}

message ListGoalsRequest {
  string user_id = 1;
  string group_id = 2;              // Optional: filter by group
  GoalStatus status = 3;            // Optional: filter by status
  GoalType goal_type = 4;           // Optional: filter by type
  int32 page_size = 5;
  string page_token = 6;
}

message ListGoalsResponse {
  repeated FinancialGoal goals = 1;
  string next_page_token = 2;
}

message GetGoalProgressRequest {
  string goal_id = 1;
  google.protobuf.Timestamp as_of_date = 2; // Optional: defaults to current date
}

message GetGoalProgressResponse {
  GoalProgress progress = 1;
}

message ContributeToGoalRequest {
  string goal_id = 1;
  string user_id = 2;
  double amount = 3;
  string note = 4;                  // Optional note for the contribution
  int64 amount_cents = 5;           // Amount in cents (preferred over amount)
}

message ContributeToGoalResponse {
  FinancialGoal goal = 1;
  GoalContribution contribution = 2;
}

message ListGoalContributionsRequest {
  string goal_id = 1;
  int32 page_size = 2;
  string page_token = 3;
}

message ListGoalContributionsResponse {
  repeated GoalContribution contributions = 1;
  string next_page_token = 2;
}

// ============================================================================
// Spending insights operations
// ============================================================================

message GetSpendingInsightsRequest {
  string user_id = 1;
  string group_id = 2;              // Optional: for group insights
  string period = 3;                // "week", "month", "quarter", "year"
  int32 limit = 4;                  // Max number of insights to return
}

message GetSpendingInsightsResponse {
  repeated SpendingInsight insights = 1;
  google.protobuf.Timestamp generated_at = 2;
}

// ============================================================================
// Document extraction operations
// ============================================================================

message ExtractDocumentRequest {
  bytes document_data = 1;              // Raw document bytes (image or PDF)
  DocumentType document_type = 2;       // Type of document
  string filename = 3;                  // Original filename for mime type detection
  bool async_processing = 4;            // If true, return job ID for async processing
  bool validate_with_api = 5;           // If true, validate with commercial API (Gemini)
  ExtractionMethod extraction_method = 6; // Which extraction method to use
}

message ExtractDocumentResponse {
  ExtractionResult result = 1;          // Extraction result (if sync)
  string job_id = 2;                    // Job ID (if async)
  ExtractionStatus status = 3;
}

message GetExtractionJobRequest {
  string job_id = 1;
}

message GetExtractionJobResponse {
  ExtractionJob job = 1;
}

message ImportExtractedTransactionsRequest {
  string user_id = 1;
  string group_id = 2;                  // Optional - import to group
  repeated ExtractedTransaction transactions = 3;
  bool skip_duplicates = 4;             // Skip transactions that appear to be duplicates
  ExpenseFrequency default_frequency = 5; // Default frequency for imported expenses
}

message ImportExtractedTransactionsResponse {
  repeated Expense created_expenses = 1;
  int32 imported_count = 2;
  int32 skipped_count = 3;
  repeated string skipped_reasons = 4;  // Reasons why transactions were skipped
}

// Smart text parsing request
message ParseExpenseTextRequest {
  string text = 1;  // Natural language expense description (e.g., "Coffee $5.50 at Starbucks yesterday")
}

// Parsed expense from natural language
message ParsedExpense {
  string description = 1;           // Cleaned merchant/description
  double amount = 2;                // Expense amount
  ExpenseCategory category = 3;     // Suggested category
  ExpenseFrequency frequency = 4;   // Detected frequency (weekly, monthly, etc.)
  google.protobuf.Timestamp date = 5;  // Detected date (if mentioned)
  repeated string split_with = 6;   // People to split with (if mentioned)
  double confidence = 7;            // Confidence score (0-1)
  string raw_input = 8;             // Original input text
  string reasoning = 9;             // Brief explanation of parsing decisions
  FieldConfidence field_confidences = 10; // Per-field confidence scores
  int64 amount_cents = 11;          // Amount in cents (preferred over amount)
}

// Smart text parsing response
message ParseExpenseTextResponse {
  ParsedExpense expense = 1;                // Primary parsed expense
  repeated ParsedExpense additional = 2;    // Additional expenses if multiple detected
  bool success = 3;                         // Whether parsing succeeded
  string error_message = 4;                 // Error message if parsing failed
}

// ============================================================================
// Recurring transaction operations
// ============================================================================

message CreateRecurringTransactionRequest {
  string user_id = 1;
  string group_id = 2;              // Optional: for group recurring transactions
  string description = 3;
  double amount = 4;
  int64 amount_cents = 5;           // Amount in cents (preferred over amount)
  ExpenseCategory category = 6;
  ExpenseFrequency frequency = 7;   // Must not be ONCE
  google.protobuf.Timestamp start_date = 8;
  google.protobuf.Timestamp end_date = 9;   // Optional: when to stop
  bool is_expense = 10;             // true = expense, false = income
  repeated string tags = 11;
  string paid_by_user_id = 12;      // For group: who pays
  SplitType split_type = 13;        // For group: how to split
  repeated ExpenseAllocation allocations = 14; // For group: member allocations
}

message CreateRecurringTransactionResponse {
  RecurringTransaction recurring_transaction = 1;
}

message GetRecurringTransactionRequest {
  string recurring_transaction_id = 1;
}

message GetRecurringTransactionResponse {
  RecurringTransaction recurring_transaction = 1;
}

message UpdateRecurringTransactionRequest {
  string recurring_transaction_id = 1;
  string description = 2;
  double amount = 3;
  int64 amount_cents = 4;           // Amount in cents (preferred over amount)
  ExpenseCategory category = 5;
  ExpenseFrequency frequency = 6;   // Must not be ONCE
  google.protobuf.Timestamp end_date = 7;   // Optional: when to stop
  bool is_expense = 8;
  repeated string tags = 9;
  string paid_by_user_id = 10;
  SplitType split_type = 11;
  repeated ExpenseAllocation allocations = 12;
}

message UpdateRecurringTransactionResponse {
  RecurringTransaction recurring_transaction = 1;
}

message DeleteRecurringTransactionRequest {
  string recurring_transaction_id = 1;
}

message ListRecurringTransactionsRequest {
  string user_id = 1;
  string group_id = 2;              // Optional: filter by group
  RecurringTransactionStatus status = 3; // Optional: filter by status
  bool filter_is_expense = 4;       // When true, use is_expense filter
  bool is_expense = 5;              // Only used when filter_is_expense is true
  int32 page_size = 6;
  string page_token = 7;
}

message ListRecurringTransactionsResponse {
  repeated RecurringTransaction recurring_transactions = 1;
  string next_page_token = 2;
}

message PauseRecurringTransactionRequest {
  string recurring_transaction_id = 1;
}

message PauseRecurringTransactionResponse {
  RecurringTransaction recurring_transaction = 1;
}

message ResumeRecurringTransactionRequest {
  string recurring_transaction_id = 1;
}

message ResumeRecurringTransactionResponse {
  RecurringTransaction recurring_transaction = 1;
}

message GetUpcomingBillsRequest {
  string user_id = 1;
  string group_id = 2;              // Optional: filter by group
  int32 days_ahead = 3;             // How many days ahead to look (default 30)
  int32 limit = 4;                  // Max results (default 10)
}

message GetUpcomingBillsResponse {
  repeated RecurringTransaction upcoming_bills = 1;
}

// ProcessRecurringTransactions is called by Cloud Scheduler to create
// expenses/incomes for all recurring transactions that are due.
message ProcessRecurringTransactionsRequest {}

message ProcessRecurringTransactionsResponse {
  int32 processed_count = 1;        // Number of transactions that generated expenses/incomes
  int32 skipped_count = 2;          // Number of active transactions not yet due
  int32 ended_count = 3;            // Number of transactions marked as ended (past end_date)
  int32 error_count = 4;            // Number of transactions that failed to process
}

// ============================================================================
// Search operations
// ============================================================================

message SearchTransactionsRequest {
  string user_id = 1;
  string group_id = 2;                          // Optional: search within a group
  string query = 3;                              // Text search query
  string category = 4;                           // Optional: filter by category
  double amount_min = 5;                         // Optional: minimum amount
  double amount_max = 6;                         // Optional: maximum amount
  int64 amount_min_cents = 7;                    // Optional: minimum amount in cents
  int64 amount_max_cents = 8;                    // Optional: maximum amount in cents
  google.protobuf.Timestamp start_date = 9;      // Optional: date range start
  google.protobuf.Timestamp end_date = 10;       // Optional: date range end
  TransactionType type = 11;                     // Optional: EXPENSE, INCOME, or ALL
  int32 page_size = 12;
  string page_token = 13;
}

message SearchTransactionsResponse {
  repeated SearchResult results = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}

// ============================================================================
// Subscription detection operations
// ============================================================================

message DetectSubscriptionsRequest {
  string user_id = 1;
  string group_id = 2;              // Optional: detect within a group
  int32 lookback_months = 3;        // How many months to analyze (default 6)
}

message DetectSubscriptionsResponse {
  repeated DetectedSubscription subscriptions = 1;
  double total_monthly_cost = 2;
  int64 total_monthly_cost_cents = 3;
  int32 forgotten_count = 4;         // Subscriptions past their expected date
}

message ConvertToRecurringRequest {
  string user_id = 1;
  DetectedSubscription subscription = 2;
}

message ConvertToRecurringResponse {
  RecurringTransaction recurring_transaction = 1;
}

// ============================================================================
// Notification operations
// ============================================================================

message ListNotificationsRequest {
  string user_id = 1;
  bool unread_only = 2;             // If true, only return unread notifications
  int32 page_size = 3;
  string page_token = 4;
  NotificationType type_filter = 5; // Optional: filter by notification type
}

message ListNotificationsResponse {
  repeated Notification notifications = 1;
  string next_page_token = 2;
  int32 total_unread = 3;
}

message MarkNotificationReadRequest {
  string notification_id = 1;
}

message MarkAllNotificationsReadRequest {
  string user_id = 1;
}

message GetUnreadNotificationCountRequest {
  string user_id = 1;
}

message GetUnreadNotificationCountResponse {
  int32 count = 1;
}

message GetNotificationPreferencesRequest {
  string user_id = 1;
}

message GetNotificationPreferencesResponse {
  NotificationPreferences preferences = 1;
}

message UpdateNotificationPreferencesRequest {
  string user_id = 1;
  NotificationPreferences preferences = 2;
}

message UpdateNotificationPreferencesResponse {
  NotificationPreferences preferences = 1;
}

// ============================================================================
// Weekly Digest operations
// ============================================================================

message GenerateWeeklyDigestRequest {
  string user_id = 1;              // Optional: generate for a specific user (empty = all opted-in users)
}

message GenerateWeeklyDigestResponse {
  int32 users_processed = 1;
  int32 digests_sent = 2;
}

// WeeklyDigestData is serialized as JSON in notification metadata
message WeeklyDigestData {
  int64 total_spent_cents = 1;
  int64 total_income_cents = 2;
  int64 net_cents = 3;
  repeated CategoryAmount top_categories = 4;
  repeated DigestBudgetSummary budget_summaries = 5;
  repeated DigestGoalSummary goal_summaries = 6;
  int32 upcoming_bills_count = 7;
  string period_start = 8;         // YYYY-MM-DD
  string period_end = 9;           // YYYY-MM-DD
}

message DigestBudgetSummary {
  string name = 1;
  int64 spent_cents = 2;
  int64 budget_cents = 3;
  double percentage_used = 4;
}

message DigestGoalSummary {
  string name = 1;
  int64 current_cents = 2;
  int64 target_cents = 3;
  double percentage_complete = 4;
}

// ============================================================================
// Stripe subscription operations
// ============================================================================

message CreateCheckoutSessionRequest {
  string user_id = 1;
  string success_url = 2;
  string cancel_url = 3;
}

message CreateCheckoutSessionResponse {
  string checkout_url = 1;
  string session_id = 2;
}

message GetSubscriptionStatusRequest {
  string user_id = 1;
}

message GetSubscriptionStatusResponse {
  SubscriptionTier tier = 1;
  SubscriptionStatus status = 2;
  google.protobuf.Timestamp current_period_end = 3;
  bool cancel_at_period_end = 4;
}

message CancelSubscriptionRequest {
  string user_id = 1;
}

message CancelSubscriptionResponse {
  SubscriptionStatus status = 1;
  bool cancel_at_period_end = 2;
}

message VerifyCheckoutSessionRequest {
  string session_id = 1;
}

message VerifyCheckoutSessionResponse {
  SubscriptionTier tier = 1;
  SubscriptionStatus status = 2;
  google.protobuf.Timestamp current_period_end = 3;
  bool cancel_at_period_end = 4;
  bool already_active = 5;
}

// ============================================================================
// Analytics operations (Pro tier)
// ============================================================================

message GetDailyAggregatesRequest {
  string user_id = 1;
  string group_id = 2;              // Optional
  google.protobuf.Timestamp start_date = 3;
  google.protobuf.Timestamp end_date = 4;
}

message GetDailyAggregatesResponse {
  repeated DailyAggregate aggregates = 1;
  double max_daily_amount = 2;
  int64 max_daily_amount_cents = 3;
}

message GetSpendingTrendsRequest {
  string user_id = 1;
  string group_id = 2;              // Optional
  Granularity granularity = 3;
  int32 periods = 4;                // Number of periods to include
  ExpenseCategory category = 5;     // Optional: filter by category
}

message GetSpendingTrendsResponse {
  repeated TimeSeriesDataPoint expense_series = 1;
  repeated TimeSeriesDataPoint income_series = 2;
  double trend_slope = 3;           // Linear regression slope
  double trend_r_squared = 4;       // R-squared for trend fit
}

message GetCategoryComparisonRequest {
  string user_id = 1;
  string group_id = 2;              // Optional
  string current_period = 3;        // "week", "month", "quarter"
  bool include_budgets = 4;
}

message GetCategoryComparisonResponse {
  repeated CategorySpending categories = 1;
}

message DetectAnomaliesRequest {
  string user_id = 1;
  string group_id = 2;              // Optional
  int32 lookback_days = 3;          // Default 90
  double sensitivity = 4;           // 0.0-1.0, default 0.5
}

message DetectAnomaliesResponse {
  repeated SpendingAnomaly anomalies = 1;
  int32 total_anomalies = 2;
  double anomalous_spend_total = 3;
  int64 anomalous_spend_total_cents = 4;
  string top_anomaly_category = 5;
}

message GetCashFlowForecastRequest {
  string user_id = 1;
  string group_id = 2;              // Optional
  int32 forecast_days = 3;          // Default 30
}

message GetCashFlowForecastResponse {
  repeated ForecastPoint income_forecast = 1;
  repeated ForecastPoint expense_forecast = 2;
  repeated ForecastPoint net_forecast = 3;
  repeated TimeSeriesDataPoint income_history = 4;
  repeated TimeSeriesDataPoint expense_history = 5;
}

message GetWaterfallDataRequest {
  string user_id = 1;
  string group_id = 2;              // Optional
  string period = 3;                // "month", "quarter", "year"
}

message GetWaterfallDataResponse {
  repeated WaterfallEntry entries = 1;
  string period_label = 2;
}

// ============================================================================
// ML Feedback operations
// ============================================================================

message SubmitCorrectionsRequest {
  string user_id = 1;
  repeated CorrectionRecord corrections = 2;
}

message SubmitCorrectionsResponse {
  int32 processed_count = 1;
  int32 merchant_mappings_updated = 2;
}

message CheckDuplicatesRequest {
  string user_id = 1;
  string group_id = 2;
  repeated ExtractedTransaction transactions = 3;
}

message CheckDuplicatesResponse {
  map<string, DuplicateCandidateList> duplicates = 1; // tx_id -> candidates
}

message DuplicateCandidateList {
  repeated DuplicateCandidate candidates = 1;
}

message GetMerchantSuggestionsRequest {
  string user_id = 1;
  string merchant_text = 2;
}

message GetMerchantSuggestionsResponse {
  string suggested_name = 1;
  ExpenseCategory suggested_category = 2;
  double confidence = 3;
  string source = 4;  // "user_history", "static", "keyword"
}

message GetExtractionMetricsRequest {
  string user_id = 1;
  int32 days = 2;  // Lookback period
}

message GetExtractionMetricsResponse {
  int32 total_extractions = 1;
  int32 total_transactions = 2;
  int32 total_corrections = 3;
  double correction_rate = 4;           // corrections / transactions
  double average_confidence = 5;
  map<string, int32> corrections_by_field = 6;  // field -> count
  map<string, int32> corrections_by_category = 7;
  repeated ExtractionEvent recent_events = 8;
}

// ============================================================================
// Tax returns operations (Pro tier)
// ============================================================================

message GetTaxSummaryRequest {
  string user_id = 1;
  string financial_year = 2;        // e.g., "2025-26"
}

message GetTaxSummaryResponse {
  TaxCalculation calculation = 1;
}

message GetTaxEstimateRequest {
  string user_id = 1;
  string financial_year = 2;        // e.g., "2025-26"
  // Optional overrides for what-if scenarios
  int64 gross_income_override_cents = 3;
  double gross_income_override = 4;
  int64 additional_deductions_cents = 5;
  double additional_deductions = 6;
  bool include_help = 7;            // Include HELP/HECS repayment
  bool medicare_exemption = 8;      // Medicare levy exemption
}

message GetTaxEstimateResponse {
  TaxCalculation calculation = 1;
}

// ExpenseTaxUpdate represents a single expense tax status update
message ExpenseTaxUpdate {
  string expense_id = 1;
  bool is_tax_deductible = 2;
  TaxDeductionCategory tax_deduction_category = 3;
  string tax_deduction_note = 4;
  double tax_deductible_percent = 5; // 0.0-1.0
}

message BatchUpdateExpenseTaxStatusRequest {
  string user_id = 1;
  repeated ExpenseTaxUpdate updates = 2; // Max 100
}

message BatchUpdateExpenseTaxStatusResponse {
  int32 updated_count = 1;
  repeated string failed_expense_ids = 2;
}

message ListDeductibleExpensesRequest {
  string user_id = 1;
  string group_id = 2;              // Optional
  string financial_year = 3;        // e.g., "2025-26"
  TaxDeductionCategory category = 4; // Optional filter
  int32 page_size = 5;
  string page_token = 6;
}

message ListDeductibleExpensesResponse {
  repeated Expense expenses = 1;
  string next_page_token = 2;
  int64 total_deductible_cents = 3;
  double total_deductible = 4;
}

// TaxClassificationResult represents AI classification for a single expense
message TaxClassificationResult {
  string expense_id = 1;
  bool is_deductible = 2;
  TaxDeductionCategory category = 3;
  double deductible_percent = 4;    // 0.0-1.0
  double confidence = 5;            // 0.0-1.0
  string reasoning = 6;             // Brief explanation
  bool auto_applied = 7;            // Whether it was auto-applied (confidence >= 0.85)
  bool needs_review = 8;            // Whether user should review (0.60-0.84)
}

message ClassifyTaxDeductibilityRequest {
  string user_id = 1;
  string expense_id = 2;
  string occupation = 3;            // User's occupation for context
}

message ClassifyTaxDeductibilityResponse {
  TaxClassificationResult result = 1;
}

message BatchClassifyTaxDeductibilityRequest {
  string user_id = 1;
  string financial_year = 2;        // e.g., "2025-26"
  string occupation = 3;            // User's occupation for context
  bool auto_apply = 4;             // Whether to auto-apply high-confidence results
}

message BatchClassifyTaxDeductibilityResponse {
  int32 total_processed = 1;
  int32 auto_applied = 2;           // Confidence >= 0.85, auto-applied
  int32 needs_review = 3;           // Confidence 0.60-0.84, flagged for review
  int32 skipped = 4;                // Confidence < 0.40 or already classified
  repeated TaxClassificationResult results = 5;
}

// ExportFormat for tax return export
enum TaxExportFormat {
  TAX_EXPORT_FORMAT_UNSPECIFIED = 0;
  TAX_EXPORT_FORMAT_CSV = 1;
  TAX_EXPORT_FORMAT_JSON = 2;
}

message ExportTaxReturnRequest {
  string user_id = 1;
  string financial_year = 2;        // e.g., "2025-26"
  TaxExportFormat format = 3;
}

message ExportTaxReturnResponse {
  bytes data = 1;
  string filename = 2;
  string content_type = 3;
  TaxCalculation calculation = 4;   // Also return the calculation summary
}

// ============================================================================
// API Token operations (Pro tier)
// ============================================================================

message CreateApiTokenRequest {
  string name = 1; // User-chosen label ("Claude Code", "Analysis Script")
}

message CreateApiTokenResponse {
  string token = 1;        // Raw token (shown once only, never stored)
  ApiToken api_token = 2;  // Token metadata
}

message ListApiTokensRequest {}

message ListApiTokensResponse {
  repeated ApiToken tokens = 1;
}

message RevokeApiTokenRequest {
  string token_id = 1;
}

message RevokeApiTokenResponse {}

syntax = "proto3";

package pfinance.v1;

import "google/protobuf/timestamp.proto";

// ExpenseCategory represents the category of an expense
enum ExpenseCategory {
  EXPENSE_CATEGORY_UNSPECIFIED = 0;
  EXPENSE_CATEGORY_FOOD = 1;
  EXPENSE_CATEGORY_HOUSING = 2;
  EXPENSE_CATEGORY_TRANSPORTATION = 3;
  EXPENSE_CATEGORY_ENTERTAINMENT = 4;
  EXPENSE_CATEGORY_HEALTHCARE = 5;
  EXPENSE_CATEGORY_UTILITIES = 6;
  EXPENSE_CATEGORY_SHOPPING = 7;
  EXPENSE_CATEGORY_EDUCATION = 8;
  EXPENSE_CATEGORY_TRAVEL = 9;
  EXPENSE_CATEGORY_OTHER = 10;
}

// ExpenseFrequency represents how often an expense occurs
enum ExpenseFrequency {
  EXPENSE_FREQUENCY_UNSPECIFIED = 0;
  EXPENSE_FREQUENCY_ONCE = 1;
  EXPENSE_FREQUENCY_DAILY = 2;
  EXPENSE_FREQUENCY_WEEKLY = 3;
  EXPENSE_FREQUENCY_FORTNIGHTLY = 4;
  EXPENSE_FREQUENCY_MONTHLY = 5;
  EXPENSE_FREQUENCY_QUARTERLY = 6;
  EXPENSE_FREQUENCY_ANNUALLY = 7;
}

// IncomeFrequency represents how often income is received
enum IncomeFrequency {
  INCOME_FREQUENCY_UNSPECIFIED = 0;
  INCOME_FREQUENCY_WEEKLY = 1;
  INCOME_FREQUENCY_FORTNIGHTLY = 2;
  INCOME_FREQUENCY_MONTHLY = 3;
  INCOME_FREQUENCY_ANNUALLY = 4;
}

// TaxStatus represents whether income is pre or post tax
enum TaxStatus {
  TAX_STATUS_UNSPECIFIED = 0;
  TAX_STATUS_PRE_TAX = 1;
  TAX_STATUS_POST_TAX = 2;
}

// TaxCountry represents supported tax systems
enum TaxCountry {
  TAX_COUNTRY_UNSPECIFIED = 0;
  TAX_COUNTRY_AUSTRALIA = 1;
  TAX_COUNTRY_UK = 2;
  TAX_COUNTRY_SIMPLE = 3;
}

// TaxDeductionCategory represents ATO deduction categories
enum TaxDeductionCategory {
  TAX_DEDUCTION_CATEGORY_UNSPECIFIED = 0;
  TAX_DEDUCTION_CATEGORY_WORK_TRAVEL = 1;      // D1 - Work-related travel
  TAX_DEDUCTION_CATEGORY_UNIFORM = 2;           // D2 - Uniform, laundry, dry-cleaning
  TAX_DEDUCTION_CATEGORY_SELF_EDUCATION = 3;    // D3 - Self-education expenses
  TAX_DEDUCTION_CATEGORY_OTHER_WORK = 4;        // D4 - Other work-related (tools, phone, subscriptions)
  TAX_DEDUCTION_CATEGORY_HOME_OFFICE = 5;       // D5 - Working from home (67c/hr or actual cost)
  TAX_DEDUCTION_CATEGORY_VEHICLE = 6;           // D6 - Car expenses (85c/km or logbook)
  TAX_DEDUCTION_CATEGORY_DONATIONS = 7;         // D15 - Gifts and donations to DGR charities
  TAX_DEDUCTION_CATEGORY_TAX_AFFAIRS = 8;       // D10 - Cost of managing tax affairs
  TAX_DEDUCTION_CATEGORY_INCOME_PROTECTION = 9; // Income protection insurance
  TAX_DEDUCTION_CATEGORY_OTHER = 10;
}

// SubscriptionTier represents the user's subscription plan
enum SubscriptionTier {
  SUBSCRIPTION_TIER_UNSPECIFIED = 0;
  SUBSCRIPTION_TIER_FREE = 1;
  SUBSCRIPTION_TIER_PRO = 2;
}

// SubscriptionStatus represents the current state of a subscription
enum SubscriptionStatus {
  SUBSCRIPTION_STATUS_UNSPECIFIED = 0;
  SUBSCRIPTION_STATUS_ACTIVE = 1;
  SUBSCRIPTION_STATUS_PAST_DUE = 2;
  SUBSCRIPTION_STATUS_CANCELED = 3;
  SUBSCRIPTION_STATUS_TRIALING = 4;
}

// User represents a user in the system
message User {
  string id = 1;
  string email = 2;
  string display_name = 3;
  google.protobuf.Timestamp created_at = 4;
  google.protobuf.Timestamp updated_at = 5;
  string photo_url = 6;
  SubscriptionTier subscription_tier = 7;
  SubscriptionStatus subscription_status = 8;
  string stripe_customer_id = 9;
  string stripe_subscription_id = 10;
}

// ApiToken represents a personal API token for programmatic access
message ApiToken {
  string id = 1;
  string user_id = 2;
  string name = 3;                          // User-chosen label ("Claude Code", "Analysis Script")
  string token_prefix = 4;                  // First 8 chars for identification ("pf_a1b2...")
  string token_hash = 5;                    // SHA-256 hash (never return full token)
  google.protobuf.Timestamp created_at = 6;
  google.protobuf.Timestamp last_used_at = 7;
  google.protobuf.Timestamp expires_at = 8; // Optional expiry
  bool is_revoked = 9;
}

// SplitType represents how an expense is split among members
enum SplitType {
  SPLIT_TYPE_UNSPECIFIED = 0;
  SPLIT_TYPE_EQUAL = 1; // Split equally among all allocated members
  SPLIT_TYPE_PERCENTAGE = 2; // Split by percentage
  SPLIT_TYPE_AMOUNT = 3; // Split by fixed amounts
  SPLIT_TYPE_SHARES = 4; // Split by shares (e.g., 2 shares for one person, 1 for another)
}

// ExpenseAllocation represents how much a specific member owes for an expense
message ExpenseAllocation {
  string user_id = 1;
  double amount = 2; // Calculated amount this user owes
  double percentage = 3; // If split by percentage
  double shares = 4; // If split by shares
  bool is_paid = 5; // Whether this allocation has been settled
  google.protobuf.Timestamp paid_at = 6;
  int64 amount_cents = 7; // Amount in cents (preferred over amount)
}

// Expense represents a single expense entry
message Expense {
  string id = 1;
  string user_id = 2; // User who created/paid for the expense
  string group_id = 3; // Optional - if part of a group
  string description = 4;
  double amount = 5;
  ExpenseCategory category = 6;
  ExpenseFrequency frequency = 7;
  google.protobuf.Timestamp date = 8;
  google.protobuf.Timestamp created_at = 9;
  google.protobuf.Timestamp updated_at = 10;

  // New fields for expense allocation
  string paid_by_user_id = 11; // Who actually paid (defaults to user_id)
  SplitType split_type = 12; // How the expense is split
  repeated ExpenseAllocation allocations = 13; // Member allocations
  bool is_settled = 14; // Whether all allocations have been settled
  repeated string tags = 15; // Optional tags for filtering/grouping
  int64 amount_cents = 16; // Amount in cents (preferred over amount)
  ExtractionMethod extraction_method = 17; // Which ML method extracted this expense (if any)

  // Tax deduction fields
  bool is_tax_deductible = 18;
  TaxDeductionCategory tax_deduction_category = 19;
  string tax_deduction_note = 20;     // e.g., "67c/hr x 200hrs"
  double tax_deductible_percent = 21; // 0.0-1.0 for partial deductions (e.g., 50% work phone)
}

// Income represents a single income entry
message Income {
  string id = 1;
  string user_id = 2;
  string group_id = 3; // Optional - if part of a group
  string source = 4;
  double amount = 5;
  IncomeFrequency frequency = 6;
  TaxStatus tax_status = 7;
  repeated Deduction deductions = 8;
  google.protobuf.Timestamp date = 9;
  google.protobuf.Timestamp created_at = 10;
  google.protobuf.Timestamp updated_at = 11;
  int64 amount_cents = 12; // Amount in cents (preferred over amount)
}

// Deduction represents a tax deduction
message Deduction {
  string id = 1;
  string name = 2;
  double amount = 3;
  bool is_tax_deductible = 4;
  int64 amount_cents = 5; // Amount in cents (preferred over amount)
}

// TaxSettings represents user's tax configuration
message TaxSettings {
  bool include_super = 1;
  double super_rate = 2;
  bool include_medicare = 3;
  bool medicare_exemption = 4;
  bool include_senior_offset = 5;
  bool include_student_loan = 6;
  double student_loan_rate = 7;
  bool include_dependent_children = 8;
  bool include_spouse = 9;
  bool include_private_health = 10;
  bool include_voluntary_super = 11;
}

// TaxConfig represents the tax configuration for a user or group
message TaxConfig {
  bool enabled = 1;
  TaxCountry country = 2;
  double tax_rate = 3;
  bool include_deductions = 4;
  TaxSettings settings = 5;
}

// FinanceGroup represents a shared finance tracking group
message FinanceGroup {
  string id = 1;
  string name = 2;
  string description = 3;
  string owner_id = 4;
  repeated string member_ids = 5;
  repeated GroupMember members = 6;
  google.protobuf.Timestamp created_at = 7;
  google.protobuf.Timestamp updated_at = 8;
}

// GroupMember represents a member of a finance group
message GroupMember {
  string user_id = 1;
  string email = 2;
  string display_name = 3;
  GroupRole role = 4;
  google.protobuf.Timestamp joined_at = 5;
}

// GroupRole represents the role of a member in a group
enum GroupRole {
  GROUP_ROLE_UNSPECIFIED = 0;
  GROUP_ROLE_VIEWER = 1;
  GROUP_ROLE_MEMBER = 2;
  GROUP_ROLE_ADMIN = 3;
  GROUP_ROLE_OWNER = 4;
}

// GroupInvitation represents an invitation to join a group
message GroupInvitation {
  string id = 1;
  string group_id = 2;
  string inviter_id = 3;
  string invitee_email = 4;
  GroupRole role = 5;
  InvitationStatus status = 6;
  google.protobuf.Timestamp created_at = 7;
  google.protobuf.Timestamp expires_at = 8;
}

// InvitationStatus represents the status of an invitation
enum InvitationStatus {
  INVITATION_STATUS_UNSPECIFIED = 0;
  INVITATION_STATUS_PENDING = 1;
  INVITATION_STATUS_ACCEPTED = 2;
  INVITATION_STATUS_DECLINED = 3;
  INVITATION_STATUS_EXPIRED = 4;
}

// BudgetPeriod represents the time period for a budget
enum BudgetPeriod {
  BUDGET_PERIOD_UNSPECIFIED = 0;
  BUDGET_PERIOD_WEEKLY = 1;
  BUDGET_PERIOD_FORTNIGHTLY = 2;
  BUDGET_PERIOD_MONTHLY = 3;
  BUDGET_PERIOD_QUARTERLY = 4;
  BUDGET_PERIOD_YEARLY = 5;
}

// Budget represents a budget configuration
message Budget {
  string id = 1;
  string user_id = 2;
  string group_id = 3; // Optional - if part of a group
  string name = 4;
  string description = 5;
  double amount = 6;
  BudgetPeriod period = 7;
  repeated ExpenseCategory category_ids = 8; // Categories this budget applies to
  bool is_active = 9;
  google.protobuf.Timestamp start_date = 10;
  google.protobuf.Timestamp end_date = 11; // Optional - for fixed period budgets
  google.protobuf.Timestamp created_at = 12;
  google.protobuf.Timestamp updated_at = 13;
  int64 amount_cents = 14; // Amount in cents (preferred over amount)
}

// BudgetAlert represents an alert configuration for a budget
message BudgetAlert {
  string id = 1;
  string budget_id = 2;
  double threshold_percentage = 3; // e.g., 50, 80, 90, 100
  bool is_enabled = 4;
  google.protobuf.Timestamp last_triggered_at = 5;
}

// BudgetProgress represents the current progress of a budget
message BudgetProgress {
  string budget_id = 1;
  double allocated_amount = 2;
  double spent_amount = 3;
  double remaining_amount = 4;
  double percentage_used = 5;
  int32 days_remaining = 6;
  google.protobuf.Timestamp period_start = 7;
  google.protobuf.Timestamp period_end = 8;
  repeated ExpenseBreakdown category_breakdown = 9;
  int64 allocated_amount_cents = 10; // Allocated amount in cents (preferred over allocated_amount)
  int64 spent_amount_cents = 11; // Spent amount in cents (preferred over spent_amount)
  int64 remaining_amount_cents = 12; // Remaining amount in cents (preferred over remaining_amount)
}

// ExpenseBreakdown represents spending breakdown by category
message ExpenseBreakdown {
  ExpenseCategory category = 1;
  double amount = 2;
  double percentage = 3;
  int64 amount_cents = 4; // Amount in cents (preferred over amount)
}

// MemberBalance represents a member's balance in a group
message MemberBalance {
  string user_id = 1;
  string group_id = 2;
  double total_paid = 3; // Total amount paid by this member
  double total_owed = 4; // Total amount allocated to this member
  double balance = 5; // total_paid - total_owed (positive means owed money, negative means owes money)
  repeated MemberDebt debts = 6; // Detailed debts to/from other members
  int64 total_paid_cents = 7; // Total paid in cents (preferred over total_paid)
  int64 total_owed_cents = 8; // Total owed in cents (preferred over total_owed)
  int64 balance_cents = 9; // Balance in cents (preferred over balance)
}

// MemberDebt represents money owed between two members
message MemberDebt {
  string from_user_id = 1; // Who owes money
  string to_user_id = 2; // Who is owed money
  double amount = 3;
  int32 expense_count = 4; // Number of expenses contributing to this debt
  int64 amount_cents = 5; // Amount in cents (preferred over amount)
}

// GroupInviteLink represents a shareable link to join a group
message GroupInviteLink {
  string id = 1;
  string group_id = 2;
  string code = 3;  // Short 8-char shareable code
  string created_by = 4;
  GroupRole default_role = 5;
  int32 max_uses = 6;
  int32 current_uses = 7;
  google.protobuf.Timestamp expires_at = 8;
  bool is_active = 9;
  google.protobuf.Timestamp created_at = 10;
}

// ExpenseContribution represents a personal expense contributed to a group
message ExpenseContribution {
  string id = 1;
  string source_expense_id = 2;  // Original personal expense
  string target_group_id = 3;
  string contributed_by = 4;
  double amount = 5;  // Amount contributed (could be partial)
  SplitType split_type = 6;
  repeated ExpenseAllocation allocations = 7;
  string created_group_expense_id = 8;  // Resulting group expense
  google.protobuf.Timestamp contributed_at = 9;
  int64 amount_cents = 10; // Amount in cents (preferred over amount)
}

// IncomeContribution represents personal income contributed to a group
message IncomeContribution {
  string id = 1;
  string source_income_id = 2;  // Original personal income
  string target_group_id = 3;
  string contributed_by = 4;
  double amount = 5;  // Amount contributed (could be partial)
  string created_group_income_id = 6;  // Resulting group income
  google.protobuf.Timestamp contributed_at = 7;
  int64 amount_cents = 8; // Amount in cents (preferred over amount)
}

// ============================================================================
// Goal Tracking
// ============================================================================

// GoalType represents the type of financial goal
enum GoalType {
  GOAL_TYPE_UNSPECIFIED = 0;
  GOAL_TYPE_SAVINGS = 1;        // Save towards a target amount
  GOAL_TYPE_DEBT_PAYOFF = 2;    // Pay off debt
  GOAL_TYPE_SPENDING_LIMIT = 3; // Limit spending in category
}

// GoalStatus represents the current status of a goal
enum GoalStatus {
  GOAL_STATUS_UNSPECIFIED = 0;
  GOAL_STATUS_ACTIVE = 1;
  GOAL_STATUS_PAUSED = 2;
  GOAL_STATUS_COMPLETED = 3;
  GOAL_STATUS_CANCELLED = 4;
}

// GoalMilestone represents a milestone within a goal
message GoalMilestone {
  string id = 1;
  string name = 2;
  double target_percentage = 3;     // e.g., 25, 50, 75, 100
  bool is_achieved = 4;
  google.protobuf.Timestamp achieved_at = 5;
}

// FinancialGoal represents a financial goal for saving, debt payoff, or spending limits
message FinancialGoal {
  string id = 1;
  string user_id = 2;
  string group_id = 3;              // Optional: for shared goals
  string name = 4;
  string description = 5;
  GoalType goal_type = 6;
  double target_amount = 7;
  double current_amount = 8;        // Computed or manually updated
  google.protobuf.Timestamp start_date = 9;
  google.protobuf.Timestamp target_date = 10;
  GoalStatus status = 11;
  repeated ExpenseCategory category_ids = 12; // For SPENDING_LIMIT type
  string icon = 13;                  // Emoji or icon name
  string color = 14;                 // Hex color for UI
  repeated GoalMilestone milestones = 15;
  google.protobuf.Timestamp created_at = 16;
  google.protobuf.Timestamp updated_at = 17;
  int64 target_amount_cents = 18; // Target amount in cents (preferred over target_amount)
  int64 current_amount_cents = 19; // Current amount in cents (preferred over current_amount)
}

// GoalProgress represents the current progress towards a goal
message GoalProgress {
  string goal_id = 1;
  double current_amount = 2;
  double target_amount = 3;
  double percentage_complete = 4;
  int32 days_remaining = 5;
  double required_daily_rate = 6;   // Amount needed per day to hit target
  double actual_daily_rate = 7;     // Current daily progress rate
  bool on_track = 8;
  repeated GoalMilestone achieved_milestones = 9;
  GoalMilestone next_milestone = 10;
  int64 current_amount_cents = 11; // Current amount in cents (preferred over current_amount)
  int64 target_amount_cents = 12; // Target amount in cents (preferred over target_amount)
  int64 required_daily_rate_cents = 13; // Required daily rate in cents (preferred over required_daily_rate)
  int64 actual_daily_rate_cents = 14; // Actual daily rate in cents (preferred over actual_daily_rate)
}

// GoalContribution represents a contribution to a goal
message GoalContribution {
  string id = 1;
  string goal_id = 2;
  string user_id = 3;
  double amount = 4;
  string note = 5;
  google.protobuf.Timestamp contributed_at = 6;
  int64 amount_cents = 7; // Amount in cents (preferred over amount)
}

// ============================================================================
// Recurring Transactions
// ============================================================================

// RecurringTransactionStatus represents the status of a recurring transaction
enum RecurringTransactionStatus {
  RECURRING_TRANSACTION_STATUS_UNSPECIFIED = 0;
  RECURRING_TRANSACTION_STATUS_ACTIVE = 1;
  RECURRING_TRANSACTION_STATUS_PAUSED = 2;
  RECURRING_TRANSACTION_STATUS_ENDED = 3;
}

// RecurringTransaction represents a recurring expense or income
message RecurringTransaction {
  string id = 1;
  string user_id = 2;
  string group_id = 3;              // Optional: for group recurring transactions
  string description = 4;
  double amount = 5;
  int64 amount_cents = 6;           // Amount in cents (preferred over amount)
  ExpenseCategory category = 7;
  ExpenseFrequency frequency = 8;   // Must not be ONCE
  google.protobuf.Timestamp start_date = 9;
  google.protobuf.Timestamp next_occurrence = 10;
  google.protobuf.Timestamp end_date = 11;  // Optional: when to stop
  RecurringTransactionStatus status = 12;
  bool is_expense = 13;             // true = expense, false = income
  google.protobuf.Timestamp created_at = 14;
  google.protobuf.Timestamp updated_at = 15;
  repeated string tags = 16;
  string paid_by_user_id = 17;      // For group: who pays
  SplitType split_type = 18;        // For group: how to split
  repeated ExpenseAllocation allocations = 19; // For group: member allocations
}

// ============================================================================
// Spending Insights
// ============================================================================

// InsightType represents the type of spending insight
enum InsightType {
  INSIGHT_TYPE_UNSPECIFIED = 0;
  INSIGHT_TYPE_SPENDING_INCREASE = 1;
  INSIGHT_TYPE_SPENDING_DECREASE = 2;
  INSIGHT_TYPE_UNUSUAL_TRANSACTION = 3;
  INSIGHT_TYPE_CATEGORY_TREND = 4;
  INSIGHT_TYPE_SAVINGS_TIP = 5;
  INSIGHT_TYPE_BUDGET_WARNING = 6;
  INSIGHT_TYPE_GOAL_PROGRESS = 7;
}

// SpendingInsight represents an AI-generated spending insight
message SpendingInsight {
  string id = 1;
  InsightType type = 2;
  string title = 3;
  string description = 4;
  string category = 5;
  double amount = 6;
  double change_percent = 7;
  string period = 8;                // e.g., "this week", "this month"
  string icon = 9;
  bool is_positive = 10;            // Good news vs warning
  google.protobuf.Timestamp created_at = 11;
  int64 amount_cents = 12; // Amount in cents (preferred over amount)
}

// ============================================================================
// Search
// ============================================================================

// TransactionType for search filtering
enum TransactionType {
  TRANSACTION_TYPE_UNSPECIFIED = 0;
  TRANSACTION_TYPE_EXPENSE = 1;
  TRANSACTION_TYPE_INCOME = 2;
}

// SearchResult represents a single search result (expense or income)
message SearchResult {
  string id = 1;
  TransactionType type = 2;
  string description = 3;
  string category = 4;
  double amount = 5;
  int64 amount_cents = 6;
  google.protobuf.Timestamp date = 7;
  string group_id = 8;
}

// ============================================================================
// Subscription Detection
// ============================================================================

// DetectedSubscription represents a subscription pattern found in expense history
message DetectedSubscription {
  string merchant_name = 1;
  string normalized_name = 2;
  string category = 3;
  double average_amount = 4;
  int64 average_amount_cents = 5;
  ExpenseFrequency detected_frequency = 6;
  double confidence_score = 7;
  int32 occurrence_count = 8;
  google.protobuf.Timestamp last_seen = 9;
  google.protobuf.Timestamp expected_next = 10;
  bool is_already_tracked = 11;      // Matches an existing recurring transaction
  repeated string matched_expense_ids = 12;
}

// ============================================================================
// Notifications
// ============================================================================

// NotificationType represents the type of notification
enum NotificationType {
  NOTIFICATION_TYPE_UNSPECIFIED = 0;
  NOTIFICATION_TYPE_BUDGET_THRESHOLD = 1;      // Budget at 50%, 80%, or 100%
  NOTIFICATION_TYPE_GOAL_MILESTONE = 2;        // Goal at 25%, 50%, 75%, or 100%
  NOTIFICATION_TYPE_BILL_REMINDER = 3;         // Upcoming recurring transaction due
  NOTIFICATION_TYPE_UNUSUAL_SPENDING = 4;      // Spending anomaly detected
  NOTIFICATION_TYPE_SUBSCRIPTION_ALERT = 5;    // Forgotten or new subscription
  NOTIFICATION_TYPE_SYSTEM = 6;                // System announcements
  NOTIFICATION_TYPE_EXTRACTION_COMPLETE = 7;   // Document extraction finished
  NOTIFICATION_TYPE_GROUP_ACTIVITY = 8;        // Group expense/income added by another member
  NOTIFICATION_TYPE_WEEKLY_DIGEST = 9;         // Weekly financial summary digest
}

// Notification represents an in-app notification
message Notification {
  string id = 1;
  string user_id = 2;
  NotificationType type = 3;
  string title = 4;
  string message = 5;
  bool is_read = 6;
  string action_url = 7;           // Deep link (e.g., "/personal/budgets/")
  string reference_id = 8;         // ID of related entity (budget, goal, etc.)
  string reference_type = 9;       // "budget", "goal", "recurring_transaction"
  google.protobuf.Timestamp created_at = 10;
  google.protobuf.Timestamp read_at = 11;
  map<string, string> metadata = 12; // Flexible data (threshold %, amount, etc.)
}

// NotificationPreferences represents a user's notification settings
message NotificationPreferences {
  string user_id = 1;
  bool budget_alerts = 2;          // Default: true
  bool goal_milestones = 3;        // Default: true
  bool bill_reminders = 4;         // Default: true
  bool unusual_spending = 5;       // Default: true
  bool subscription_alerts = 6;    // Default: true
  bool weekly_digest = 7;          // Default: false
  int32 bill_reminder_days = 8;    // Days before due date (default: 3)
}

// ============================================================================
// Document Extraction
// ============================================================================

// DocumentType represents the type of document being processed
enum DocumentType {
  DOCUMENT_TYPE_UNSPECIFIED = 0;
  DOCUMENT_TYPE_RECEIPT = 1;
  DOCUMENT_TYPE_BANK_STATEMENT = 2;
  DOCUMENT_TYPE_INVOICE = 3;
}

// ExtractionStatus represents the status of an extraction job
enum ExtractionStatus {
  EXTRACTION_STATUS_UNSPECIFIED = 0;
  EXTRACTION_STATUS_PENDING = 1;
  EXTRACTION_STATUS_PROCESSING = 2;
  EXTRACTION_STATUS_COMPLETED = 3;
  EXTRACTION_STATUS_FAILED = 4;
  EXTRACTION_STATUS_VALIDATION_REQUIRED = 5;
}

// ExtractionMethod represents which ML model/service to use for extraction
enum ExtractionMethod {
  EXTRACTION_METHOD_UNSPECIFIED = 0;  // Use default (self-hosted ML)
  EXTRACTION_METHOD_SELF_HOSTED = 1;  // Self-hosted Qwen2-VL model
  EXTRACTION_METHOD_GEMINI = 2;       // Google Gemini API
}

// ExtractedTransaction represents a single transaction extracted from a document
message ExtractedTransaction {
  string id = 1;
  string date = 2;                        // Date in YYYY-MM-DD format
  string description = 3;                 // Raw description from document
  string normalized_merchant = 4;         // Cleaned/normalized merchant name
  double amount = 5;                      // Transaction amount (positive)
  ExpenseCategory suggested_category = 6; // AI-suggested category
  double confidence = 7;                  // Extraction confidence (0.0-1.0)
  bool is_debit = 8;                      // True if money going out
  string reference = 9;                   // Transaction reference if available
  repeated ExtractedLineItem line_items = 10; // Itemized line items for receipts
  int64 amount_cents = 11; // Amount in cents (preferred over amount)
  FieldConfidence field_confidences = 12; // Per-field confidence scores
}

// ExtractedLineItem represents a single line item from a receipt
message ExtractedLineItem {
  string description = 1;
  double amount = 2;
  int32 quantity = 3;
  ExpenseCategory category = 4;
  int64 amount_cents = 5; // Amount in cents (preferred over amount)
}

// FieldConfidence represents per-field extraction confidence scores
message FieldConfidence {
  double amount = 1;
  double date = 2;
  double description = 3;
  double merchant = 4;
  double category = 5;
}

// ExtractionErrorDetail represents structured error information from extraction
message ExtractionErrorDetail {
  string code = 1;
  string message = 2;
  bool retryable = 3;
  string suggested_action = 4;
  ExtractionMethod failed_method = 5;
}

// ExtractionResult represents the result of document extraction
message ExtractionResult {
  repeated ExtractedTransaction transactions = 1;
  double overall_confidence = 2;
  string model_used = 3;
  int32 processing_time_ms = 4;
  repeated string warnings = 5;
  DocumentType document_type = 6;
  int32 page_count = 7;
  repeated ExtractedTransaction rejected_transactions = 8;
  ExtractionMethod method_used = 9;
  ExtractionMethod fallback_from = 10;
  StatementMetadata statement_metadata = 11;  // Populated for bank statements
}

// StatementMetadata contains identifying information extracted from a bank statement
message StatementMetadata {
  string bank_name = 1;          // e.g. "ANZ", "Commonwealth Bank"
  string account_identifier = 2; // Last 4 digits or masked account number
  string period_start = 3;       // YYYY-MM-DD
  string period_end = 4;         // YYYY-MM-DD
  int32 transaction_count = 5;   // Number of transactions detected
  string currency = 6;           // e.g. "AUD"
  string fingerprint = 7;        // SHA256 of bank+account+period_start+period_end
}

// ProcessedStatement tracks which statements have been imported to prevent duplicates
message ProcessedStatement {
  string id = 1;
  string user_id = 2;
  string fingerprint = 3;
  string bank_name = 4;
  string account_identifier = 5;
  string period_start = 6;
  string period_end = 7;
  int32 imported_count = 8;
  google.protobuf.Timestamp processed_at = 9;
  string original_filename = 10;
}

// ExtractionJob represents an async extraction job
message ExtractionJob {
  string id = 1;
  string user_id = 2;
  ExtractionStatus status = 3;
  DocumentType document_type = 4;
  string original_filename = 5;
  ExtractionResult result = 6;
  string error_message = 7;
  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp completed_at = 9;
  int32 total_pages = 10;
  int32 processed_pages = 11;
  int32 current_page = 12;
  double progress_percent = 13;
  ExtractionMethod method = 14;
}

// ValidationResult represents the result of validating an extraction
message ValidationResult {
  double accuracy = 1;
  repeated ValidationDiscrepancy discrepancies = 2;
  string validated_by = 3;              // Model/method used for validation
  google.protobuf.Timestamp validated_at = 4;
}

// ValidationDiscrepancy represents a difference found during validation
message ValidationDiscrepancy {
  string field = 1;                     // Field with discrepancy
  string extracted_value = 2;
  string validated_value = 3;
  string transaction_id = 4;
}

// ============================================================================
// Analytics
// ============================================================================

// Granularity for time series aggregation
enum Granularity {
  GRANULARITY_UNSPECIFIED = 0;
  GRANULARITY_DAY = 1;
  GRANULARITY_WEEK = 2;
  GRANULARITY_MONTH = 3;
}

// AnomalyType categorizes the kind of spending anomaly
enum AnomalyType {
  ANOMALY_TYPE_UNSPECIFIED = 0;
  ANOMALY_TYPE_AMOUNT_OUTLIER = 1;     // Unusually high or low amount
  ANOMALY_TYPE_NEW_MERCHANT = 2;       // First-time merchant
  ANOMALY_TYPE_UNUSUAL_TIMING = 3;     // Unusual time of day/week
  ANOMALY_TYPE_CATEGORY_SPIKE = 4;     // Category spending spike
}

// AnomalySeverity indicates how unusual the anomaly is
enum AnomalySeverity {
  ANOMALY_SEVERITY_UNSPECIFIED = 0;
  ANOMALY_SEVERITY_LOW = 1;
  ANOMALY_SEVERITY_MEDIUM = 2;
  ANOMALY_SEVERITY_HIGH = 3;
}

// DailyAggregate represents spending aggregated for a single day
message DailyAggregate {
  string date = 1;                     // YYYY-MM-DD format
  double total_amount = 2;
  int64 total_amount_cents = 3;
  int32 transaction_count = 4;
  repeated CategoryAmount category_amounts = 5;
}

// CategoryAmount represents spending in a single category
message CategoryAmount {
  ExpenseCategory category = 1;
  double amount = 2;
  int64 amount_cents = 3;
  int32 count = 4;
}

// TimeSeriesDataPoint represents a single point in a time series
message TimeSeriesDataPoint {
  string date = 1;                     // ISO date string
  double value = 2;
  int64 value_cents = 3;
  string label = 4;                    // Optional label
}

// CategorySpending represents a category's spending for comparison
message CategorySpending {
  ExpenseCategory category = 1;
  double current_amount = 2;
  int64 current_amount_cents = 3;
  double previous_amount = 4;
  int64 previous_amount_cents = 5;
  double budget_amount = 6;
  int64 budget_amount_cents = 7;
  double change_percent = 8;
}

// SpendingAnomaly represents a detected spending anomaly
message SpendingAnomaly {
  string id = 1;
  string expense_id = 2;
  string description = 3;
  double amount = 4;
  int64 amount_cents = 5;
  ExpenseCategory category = 6;
  google.protobuf.Timestamp date = 7;
  double z_score = 8;
  double expected_amount = 9;
  int64 expected_amount_cents = 10;
  AnomalyType anomaly_type = 11;
  AnomalySeverity severity = 12;
}

// ForecastPoint represents a single forecast data point
message ForecastPoint {
  string date = 1;                     // YYYY-MM-DD
  double predicted = 2;
  int64 predicted_cents = 3;
  double lower_bound = 4;
  int64 lower_bound_cents = 5;
  double upper_bound = 6;
  int64 upper_bound_cents = 7;
  bool is_recurring = 8;              // True if driven by a recurring transaction
}

// WaterfallEntryType categorizes waterfall chart entries
enum WaterfallEntryType {
  WATERFALL_ENTRY_TYPE_UNSPECIFIED = 0;
  WATERFALL_ENTRY_TYPE_INCOME = 1;
  WATERFALL_ENTRY_TYPE_EXPENSE = 2;
  WATERFALL_ENTRY_TYPE_TAX = 3;
  WATERFALL_ENTRY_TYPE_SAVINGS = 4;
  WATERFALL_ENTRY_TYPE_SUBTOTAL = 5;
}

// WaterfallEntry represents a single bar in a waterfall chart
message WaterfallEntry {
  string label = 1;
  double amount = 2;
  int64 amount_cents = 3;
  WaterfallEntryType entry_type = 4;
  double running_total = 5;
  int64 running_total_cents = 6;
}

// ============================================================================
// ML Feedback & Correction Tracking
// ============================================================================

// CorrectionFieldType represents which field was corrected
enum CorrectionFieldType {
  CORRECTION_FIELD_TYPE_UNSPECIFIED = 0;
  CORRECTION_FIELD_TYPE_AMOUNT = 1;
  CORRECTION_FIELD_TYPE_CATEGORY = 2;
  CORRECTION_FIELD_TYPE_DESCRIPTION = 3;
  CORRECTION_FIELD_TYPE_DATE = 4;
  CORRECTION_FIELD_TYPE_MERCHANT = 5;
}

// FieldCorrection represents a single field-level correction
message FieldCorrection {
  CorrectionFieldType field = 1;
  string original_value = 2;
  string corrected_value = 3;
}

// CorrectionRecord captures user corrections to extracted data
message CorrectionRecord {
  string id = 1;
  string user_id = 2;
  string extraction_id = 3;           // Links to ExtractionResult
  string transaction_id = 4;          // Links to ExtractedTransaction
  repeated FieldCorrection corrections = 5;
  string original_merchant = 6;
  string corrected_merchant = 7;
  ExpenseCategory original_category = 8;
  ExpenseCategory corrected_category = 9;
  double original_confidence = 10;
  google.protobuf.Timestamp created_at = 11;
  ExtractionMethod extraction_method = 12;
}

// MerchantMapping stores learned merchant->category associations from user corrections
message MerchantMapping {
  string id = 1;
  string user_id = 2;
  string raw_pattern = 3;             // Original merchant string pattern
  string normalized_name = 4;         // User-corrected clean name
  ExpenseCategory category = 5;
  int32 correction_count = 6;         // How many times user corrected to this
  double confidence = 7;              // Derived from correction_count
  google.protobuf.Timestamp last_used = 8;
  google.protobuf.Timestamp created_at = 9;
}

// ExtractionEvent tracks extraction quality metrics over time
message ExtractionEvent {
  string id = 1;
  string user_id = 2;
  ExtractionMethod method = 3;
  int32 transaction_count = 4;
  int32 accepted_count = 5;
  int32 rejected_count = 6;
  int32 corrected_count = 7;
  double overall_confidence = 8;
  int32 processing_time_ms = 9;
  DocumentType document_type = 10;
  google.protobuf.Timestamp created_at = 11;
}

// DuplicateCandidate represents a potential duplicate of an extracted transaction
message DuplicateCandidate {
  string existing_expense_id = 1;
  string description = 2;
  double amount = 3;
  int64 amount_cents = 4;
  string date = 5;
  ExpenseCategory category = 6;
  double match_score = 7;             // 0.0-1.0 similarity
  string match_reason = 8;            // "Same amount + date", "Similar merchant"
}

// ============================================================================
// Tax Returns
// ============================================================================

// TaxDeductionSummary represents aggregated deductions for a single category
message TaxDeductionSummary {
  TaxDeductionCategory category = 1;
  int64 total_cents = 2;
  double total_amount = 3;
  int32 expense_count = 4;
}

// TaxCalculation represents a full Australian tax estimate
message TaxCalculation {
  string financial_year = 1;            // e.g., "2025-26"
  int64 gross_income_cents = 2;
  double gross_income = 3;
  repeated TaxDeductionSummary deductions = 4;
  int64 total_deductions_cents = 5;
  double total_deductions = 6;
  int64 taxable_income_cents = 7;
  double taxable_income = 8;
  int64 base_tax_cents = 9;
  double base_tax = 10;
  int64 medicare_levy_cents = 11;
  double medicare_levy = 12;
  int64 help_repayment_cents = 13;
  double help_repayment = 14;
  int64 lito_cents = 15;                // Low Income Tax Offset (negative = reduction)
  double lito = 16;
  int64 total_tax_cents = 17;
  double total_tax = 18;
  double effective_rate = 19;           // Total tax / gross income
  int64 refund_or_owed_cents = 20;      // Positive = refund, negative = owed
  double refund_or_owed = 21;
  int64 tax_withheld_cents = 22;        // From income records
  double tax_withheld = 23;
}

// TaxDeductibilityMapping stores learned merchant->deduction patterns
message TaxDeductibilityMapping {
  string id = 1;
  string user_id = 2;
  string merchant_pattern = 3;         // Merchant name pattern
  TaxDeductionCategory deduction_category = 4;
  double deductible_percent = 5;       // 0.0-1.0
  int32 confirmation_count = 6;        // How many times user confirmed
  double confidence = 7;               // Derived from confirmation_count
  google.protobuf.Timestamp last_used = 8;
  google.protobuf.Timestamp created_at = 9;
}

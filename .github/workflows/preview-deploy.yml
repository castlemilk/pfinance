name: Preview Deploy

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, closed]

concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  PROJECT_ID: pfinance-app-1748773335
  REGION: us-central1
  IMAGE_NAME: gcr.io/pfinance-app-1748773335/pfinance-backend-preview
  WORKLOAD_IDENTITY_PROVIDER: projects/859800863588/locations/global/workloadIdentityPools/github-pool/providers/github-provider
  SERVICE_ACCOUNT: github-actions@pfinance-app-1748773335.iam.gserviceaccount.com

jobs:
  # ===========================================
  # Change Detection
  # ===========================================
  changes:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'web/**'
              - 'proto/**'
            backend:
              - 'backend/**'
              - 'proto/**'

  # ===========================================
  # Frontend Preview â†’ Vercel
  # ===========================================
  # ===========================================
  # Backend Preview (or Prod Fallback)
  # ===========================================
  backend:
    needs: changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    outputs:
      url: ${{ steps.get-url.outputs.url }}
      deployed: ${{ steps.deploy.outputs.deployed }}
    environment:
      name: preview
      url: ${{ steps.get-url.outputs.url }}
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - id: deploy
        if: needs.changes.outputs.backend == 'true'
        run: |
          gcloud auth configure-docker
          
          # Setup Buf
          # We can't use the action inside a conditional easily if it sets up env vars globally, 
          # but we can try or just install it manually / use the action unconditionally?
          # The action is fast. Let's move it out or just run it.
          
          echo "deployed=true" >> $GITHUB_OUTPUT

      - uses: actions/setup-go@v5
        if: needs.changes.outputs.backend == 'true'
        with:
          go-version: '1.23'

      - uses: bufbuild/buf-setup-action@v1
        if: needs.changes.outputs.backend == 'true'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Deploy
        if: needs.changes.outputs.backend == 'true'
        run: |
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install connectrpc.com/connect/cmd/protoc-gen-connect-go@latest
          go install go.uber.org/mock/mockgen@latest
          export PATH=$PATH:$(go env GOPATH)/bin
          cd proto && buf generate --template buf.gen.go.yaml
          cd ../backend
          
          TAG="pr-${{ github.event.pull_request.number }}"
          SERVICE="pfinance-backend-preview-$TAG"
          
          docker build -t ${{ env.IMAGE_NAME }}:$TAG .
          docker push ${{ env.IMAGE_NAME }}:$TAG
          
          gcloud run deploy $SERVICE \
            --image ${{ env.IMAGE_NAME }}:$TAG \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --port 8111 \
            --memory 256Mi \
            --max-instances 2 \
            --set-env-vars GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }} \
            --quiet
          
          URL=$(gcloud run services describe $SERVICE --region ${{ env.REGION }} --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_ENV

      - name: Get Backend URL (Fallback)
        if: needs.changes.outputs.backend != 'true'
        run: |
          # Fetch production URL
          URL=$(gcloud run services describe pfinance-backend --region ${{ env.REGION }} --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_ENV

      - id: get-url
        run: echo "url=${{ env.url }}" >> $GITHUB_OUTPUT

      - name: Comment PR
        if: needs.changes.outputs.backend == 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸ”§ **Backend Preview:** ${{ env.url }}\n\nHealth: ${{ env.url }}/health`
            });

  # ===========================================
  # Frontend Preview â†’ Vercel
  # ===========================================
  frontend:
    needs: [changes, backend]
    if: needs.changes.outputs.frontend == 'true' || needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    environment:
      name: preview
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Deploy
        id: deploy
        env:
          BACKEND_URL: ${{ needs.backend.outputs.url }}
        working-directory: web
        run: |
          npm i -g vercel@latest
          # Deploy and let Vercel build on their servers (avoids platform-specific dep issues)
          URL=$(vercel --token=${{ secrets.VERCEL_TOKEN }} --env NEXT_PUBLIC_API_URL=$BACKEND_URL --yes)
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Comment PR
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ **Frontend Preview:** ${{ steps.deploy.outputs.url }}\nðŸ”— **API:** ${{ needs.backend.outputs.url }}`
            });

  # ===========================================
  # Cleanup on PR Close
  # ===========================================
  cleanup:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Delete preview
        run: |
          SERVICE="pfinance-backend-preview-pr-${{ github.event.pull_request.number }}"
          gcloud run services delete $SERVICE --region ${{ env.REGION }} --quiet 2>/dev/null || true
          echo "âœ“ Cleaned up $SERVICE"

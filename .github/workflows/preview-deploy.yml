name: Preview Deploy

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, closed]

concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  PROJECT_ID: pfinance-app-1748773335
  REGION: us-central1
  IMAGE_NAME: gcr.io/pfinance-app-1748773335/pfinance-backend-preview
  WORKLOAD_IDENTITY_PROVIDER: projects/859800863588/locations/global/workloadIdentityPools/github-pool/providers/github-provider
  SERVICE_ACCOUNT: github-actions@pfinance-app-1748773335.iam.gserviceaccount.com
  # Preview domain - configure *.preview.pfinance.dev in Vercel
  PREVIEW_DOMAIN: preview.pfinance.dev

jobs:
  # ===========================================
  # Change Detection
  # ===========================================
  changes:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'web/**'
              - 'proto/**'
            backend:
              - 'backend/**'
              - 'proto/**'

  # ===========================================
  # Backend Preview ‚Üí Cloud Run
  # ===========================================
  backend:
    needs: changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    outputs:
      url: ${{ steps.get-url.outputs.url }}
      deployed: ${{ steps.deploy.outputs.deployed }}
    environment:
      name: preview
      url: ${{ steps.get-url.outputs.url }}
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - id: deploy
        if: needs.changes.outputs.backend == 'true'
        run: |
          gcloud auth configure-docker
          echo "deployed=true" >> $GITHUB_OUTPUT

      - uses: actions/setup-go@v5
        if: needs.changes.outputs.backend == 'true'
        with:
          go-version: '1.25'
          cache: true
          cache-dependency-path: backend/go.sum

      - uses: bufbuild/buf-setup-action@v1
        if: needs.changes.outputs.backend == 'true'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Deploy
        if: needs.changes.outputs.backend == 'true'
        run: |
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install connectrpc.com/connect/cmd/protoc-gen-connect-go@latest
          go install go.uber.org/mock/mockgen@latest
          export PATH=$PATH:$(go env GOPATH)/bin
          cd proto && buf generate --template buf.gen.go.yaml
          cd ../backend

          TAG="pr-${{ github.event.pull_request.number }}"
          SERVICE="pfinance-backend-preview-$TAG"

          docker build -t ${{ env.IMAGE_NAME }}:$TAG .
          docker push ${{ env.IMAGE_NAME }}:$TAG

          gcloud run deploy $SERVICE \
            --image ${{ env.IMAGE_NAME }}:$TAG \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --port 8111 \
            --memory 256Mi \
            --max-instances 2 \
            --set-env-vars "GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }},GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }},STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }},STRIPE_PRICE_ID=${{ secrets.STRIPE_PRICE_ID }},STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}" \
            --quiet

          URL=$(gcloud run services describe $SERVICE --region ${{ env.REGION }} --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_ENV

      - name: Get Backend URL (Fallback to Production)
        if: needs.changes.outputs.backend != 'true'
        run: |
          URL=$(gcloud run services describe pfinance-backend --region ${{ env.REGION }} --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_ENV

      - id: get-url
        run: echo "url=${{ env.url }}" >> $GITHUB_OUTPUT

      - name: Comment PR (Backend)
        if: needs.changes.outputs.backend == 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üîß **Backend Preview:** ${{ env.url }}\n\nHealth: ${{ env.url }}/health`
            });

  # ===========================================
  # Frontend Preview ‚Üí Vercel
  # ===========================================
  frontend:
    needs: [changes, backend]
    if: needs.changes.outputs.frontend == 'true' || needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    environment:
      name: preview
      url: ${{ steps.deploy.outputs.preview_url }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Deploy to Vercel
        id: deploy
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: team_xE5DMN3hIo8aPqyHNkBybg8r
          VERCEL_PROJECT_ID: prj_TakUttZsa4fdddSwfVp08YFfyAdF
          BACKEND_URL: ${{ needs.backend.outputs.url }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          npm i -g vercel@latest
          cd web

          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_ALIAS="pr-${PR_NUMBER}.${{ env.PREVIEW_DOMAIN }}"
          LATEST_ALIAS="${{ env.PREVIEW_DOMAIN }}"

          # Link to Vercel project and pull config (run from repo root)
          cd ..
          vercel pull --yes --environment=preview --token=$VERCEL_TOKEN

          # Build the project with the backend URL (NEXT_PUBLIC_ vars need to be set at build time)
          NEXT_PUBLIC_API_URL=$BACKEND_URL GEMINI_API_KEY=$GEMINI_API_KEY vercel build --token=$VERCEL_TOKEN

          # Deploy the prebuilt project with server-side env vars
          DEPLOY_URL=$(vercel deploy --prebuilt --token=$VERCEL_TOKEN --env GEMINI_API_KEY=$GEMINI_API_KEY)
          echo "Deployed to: $DEPLOY_URL"

          # Alias to PR-specific preview domain (e.g., pr-123.preview.pfinance.dev)
          echo "Aliasing to $PR_ALIAS..."
          vercel alias set $DEPLOY_URL $PR_ALIAS --token=$VERCEL_TOKEN --scope=$VERCEL_ORG_ID

          # Also alias to latest preview domain (preview.pfinance.dev)
          echo "Aliasing to $LATEST_ALIAS..."
          vercel alias set $DEPLOY_URL $LATEST_ALIAS --token=$VERCEL_TOKEN --scope=$VERCEL_ORG_ID

          # Output URLs
          echo "deploy_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          echo "preview_url=https://$PR_ALIAS" >> $GITHUB_OUTPUT
          echo "latest_url=https://$LATEST_ALIAS" >> $GITHUB_OUTPUT
          echo "alias_success=true" >> $GITHUB_OUTPUT

      - name: Comment PR
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const aliasSuccess = '${{ steps.deploy.outputs.alias_success }}' === 'true';
            const prUrl = aliasSuccess
              ? 'https://pr-${{ github.event.pull_request.number }}.${{ env.PREVIEW_DOMAIN }}'
              : '${{ steps.deploy.outputs.deploy_url }}';
            const latestUrl = 'https://${{ env.PREVIEW_DOMAIN }}';

            const body = `## üöÄ Preview Deployment Ready!

            | Service | URL |
            |---------|-----|
            | **Frontend (this PR)** | ${prUrl} |
            | **Frontend (latest)** | ${latestUrl} |
            | **API** | ${{ needs.backend.outputs.url }} |

            ${aliasSuccess ? '> ‚ú® This PR is now live at **preview.pfinance.dev**' : '> ‚ö†Ô∏è Custom domain alias not configured. Using Vercel URL.'}

            ---
            <sub>Preview deployments are automatically cleaned up when the PR is closed.</sub>`;

            // Find and update existing comment or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Preview Deployment Ready')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # ===========================================
  # E2E Tests against Preview
  # ===========================================
  e2e-preview:
    needs: [frontend]
    if: needs.frontend.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('web/package-lock.json') }}

      - name: Install dependencies
        run: cd web && npm install --legacy-peer-deps

      - name: Install Playwright (Chromium only)
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        working-directory: web
        run: npm exec playwright -- install chromium --with-deps

      - name: Install Playwright deps (if cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        working-directory: web
        run: npm exec playwright -- install-deps chromium

      - name: Wait for preview to be ready
        run: |
          URL="https://pr-${{ github.event.pull_request.number }}.${{ env.PREVIEW_DOMAIN }}"
          echo "Waiting for $URL to be ready..."
          timeout 120 bash -c "until curl -sf --max-time 5 \"$URL\" > /dev/null 2>&1; do echo 'Waiting...'; sleep 5; done" || {
            echo "::warning::Preview at $URL not ready after 120s, skipping E2E"
            echo "SKIP_E2E=true" >> $GITHUB_ENV
          }
          echo "Preview ready!"

      - name: Run E2E tests against preview
        if: env.SKIP_E2E != 'true'
        working-directory: web
        run: npm run test:e2e:preview -- --reporter=list
        env:
          PREVIEW_URL: https://pr-${{ github.event.pull_request.number }}.${{ env.PREVIEW_DOMAIN }}

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-preview-report
          path: web/test-results/
          retention-days: 7

      - name: Comment PR with test results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const success = '${{ job.status }}' === 'success';
            const emoji = success ? '‚úÖ' : '‚ùå';
            const status = success ? 'passed' : 'failed';

            // Find existing E2E comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('E2E Preview Tests')
            );

            const body = `### ${emoji} E2E Preview Tests ${status}

            Tested against: https://pr-${{ github.event.pull_request.number }}.${{ env.PREVIEW_DOMAIN }}

            ${success ? 'All smoke tests passed!' : 'Some tests failed. Check the workflow logs for details.'}`;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # ===========================================
  # Cleanup on PR Close
  # ===========================================
  cleanup:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Delete Cloud Run preview
        run: |
          SERVICE="pfinance-backend-preview-pr-${{ github.event.pull_request.number }}"
          gcloud run services delete $SERVICE --region ${{ env.REGION }} --quiet 2>/dev/null || true
          echo "‚úì Cleaned up Cloud Run service: $SERVICE"

      - name: Remove Vercel alias
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          npm i -g vercel@latest
          ALIAS="pr-${{ github.event.pull_request.number }}.${{ env.PREVIEW_DOMAIN }}"
          vercel remove $ALIAS --token=$VERCEL_TOKEN --yes 2>/dev/null || true
          echo "‚úì Removed Vercel alias: $ALIAS"
